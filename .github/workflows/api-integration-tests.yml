name: Real API Integration Tests

# Run real API tests on a schedule to avoid rate limiting during regular CI
on:
  schedule:
    # Run nightly at 2 AM UTC (off-peak hours to respect API rate limits)
    - cron: '0 2 * * *'

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      test_pattern:
        description: 'Test pattern to run (e.g., test_research_agent.py)'
        required: false
        default: ''

env:
  PYTHONPATH: ${{ github.workspace }}
  PYTEST_ADDOPTS: "--color=yes --tb=short"

jobs:
  real-api-tests:
    name: Real API Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Allow this job to fail without blocking other workflows
    continue-on-error: true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: 3.12
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run real API integration tests
      env:
        # API keys for external services
        NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
        ENTREZ_EMAIL: ${{ secrets.ENTREZ_EMAIL }}
        AWS_BEDROCK_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_ACCESS_KEY }}
        AWS_BEDROCK_SECRET_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_SECRET_ACCESS_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        if [ -n "${{ github.event.inputs.test_pattern }}" ]; then
          # Manual trigger with specific test pattern
          python -m pytest tests/integration/${{ github.event.inputs.test_pattern }} \
            -m "real_api" \
            --maxfail=5 \
            --timeout=600 \
            --cov=lobster \
            --cov-report=xml:coverage-real-api.xml \
            --cov-report=term \
            --junit-xml=real-api-results.xml \
            --durations=10 \
            -v
        else
          # Scheduled run - all real API tests
          python -m pytest tests/integration/ \
            -m "real_api" \
            --maxfail=5 \
            --timeout=600 \
            --cov=lobster \
            --cov-report=xml:coverage-real-api.xml \
            --cov-report=term \
            --junit-xml=real-api-results.xml \
            --durations=10 \
            -v
        fi

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: real-api-test-results
        path: |
          real-api-results.xml
          coverage-real-api.xml
        retention-days: 30

    - name: Upload coverage to artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: real-api-coverage
        path: coverage-real-api.xml
        retention-days: 30

    - name: Comment on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const issue_number = context.issue.number;
          if (issue_number) {
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: '⚠️ Real API integration tests failed. This may be due to external service issues, rate limiting, or API changes. Please review the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).'
            });
          }

  # Summary job to provide overview
  api-test-summary:
    name: API Test Summary
    runs-on: ubuntu-latest
    needs: [real-api-tests]
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "## Real API Integration Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Real API Tests**: ${{ needs.real-api-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ needs.real-api-tests.result }}" == "success" ]]; then
          echo "✅ **All real API integration tests passed**" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.real-api-tests.result }}" == "failure" ]]; then
          echo "⚠️ **Real API tests failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is expected occasionally due to:" >> $GITHUB_STEP_SUMMARY
          echo "- External service rate limiting (NCBI/PubMed)" >> $GITHUB_STEP_SUMMARY
          echo "- Network issues or service outages" >> $GITHUB_STEP_SUMMARY
          echo "- API changes or data availability" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the [test results artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details." >> $GITHUB_STEP_SUMMARY
        else
          echo "⏭️ **Real API tests were skipped or cancelled**" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Marker**: \`@pytest.mark.real_api\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Timeout**: 600 seconds per test" >> $GITHUB_STEP_SUMMARY
        echo "- **Schedule**: Nightly at 2 AM UTC" >> $GITHUB_STEP_SUMMARY
        echo "- **Coverage Report**: \`coverage-real-api.xml\`" >> $GITHUB_STEP_SUMMARY
