name: Basic CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHONPATH: ${{ github.workspace }}
  PYTEST_ADDOPTS: "--color=yes --tb=short"

jobs:
  # =====================================================================
  # Code Quality and Unit Tests
  # =====================================================================
  quality-and-tests:
    name: Code Quality & Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        df -h

    - name: Install dependencies
      run: |
        python -m pip install --no-cache-dir --upgrade pip
        pip install --no-cache-dir -e ".[dev]"

    - name: Run linting
      run: |
        pip install ruff
        ruff check lobster/ || echo "Ruff linting completed with issues"

    - name: Run unit/config tests
      run: |
        python -m pytest tests/unit/config \
          --maxfail=10 \
          --durations=10 \
          -v

    - name: Run unit/backend tests
      run: |
        python -m pytest tests/unit/core/backends \
          --maxfail=10 \
          --durations=10 \
          -v

    - name: Run unit/core tests
      run: |
        python -m pytest \
          tests/unit/core/test_client.py \
          tests/unit/core/test_schemas.py \
          tests/unit/core/test_data_manager_v2.py \
          --maxfail=10 \
          --durations=10 \
          -v

    - name: Run unit/agents tests
      env:
        AWS_BEDROCK_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_ACCESS_KEY }}
        AWS_BEDROCK_SECRET_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_SECRET_ACCESS_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
      run: |
        python -m pytest \
          tests/unit/agents/test_agent_registry.py \
          tests/unit/agents/test_supervisor.py \
          tests/unit/agents/test_research_agent.py \
          tests/unit/agents/test_data_expert.py \
          --maxfail=10 \
          --durations=10 \
          -v

  # =====================================================================
  # Build Verification
  # =====================================================================
  build-test:
    name: Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Build and verify package
      run: |
        python -m pip install --no-cache-dir --upgrade pip
        pip install --no-cache-dir build twine
        python -m build
        twine check dist/*
        pip install --no-cache-dir dist/*.whl
        python -c "from lobster.version import __version__; print(f'lobster-ai {__version__} installed')"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 7

  # =====================================================================
  # Integration Tests (main branch only)
  # =====================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [quality-and-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --no-cache-dir --upgrade pip
        pip install --no-cache-dir -e ".[dev]"

    - name: Run integration tests
      env:
        AWS_BEDROCK_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_ACCESS_KEY }}
        AWS_BEDROCK_SECRET_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_SECRET_ACCESS_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
      run: |
        if [ -d "tests/integration" ]; then
          python -m pytest tests/integration/ \
            -m "not real_api and not slow" \
            --maxfail=5 \
            --timeout=300 \
            --durations=10 \
            -v || echo "Integration tests completed with some failures (non-blocking)"
        fi

  # =====================================================================
  # Summary
  # =====================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [quality-and-tests, build-test, integration-tests]
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "## CI Results" >> $GITHUB_STEP_SUMMARY
        echo "- Code Quality & Tests: ${{ needs.quality-and-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build Test: ${{ needs.build-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
