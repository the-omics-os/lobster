name: Basic CI

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main, development]

env:
  PYTHONPATH: ${{ github.workspace }}
  PYTEST_ADDOPTS: "--color=yes --tb=short"

jobs:
  # =====================================================================
  # Code Quality and Unit Tests
  # =====================================================================
  quality-and-tests:
    name: Code Quality & Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: 3.12
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run linting and formatting checks
      run: |
        # Basic linting with ruff if available
        if command -v ruff &> /dev/null; then
          echo "Running ruff linting..."
          ruff check lobster/ || echo "Ruff linting completed with issues"
        elif pip show flake8 &> /dev/null; then
          echo "Running flake8 linting..."
          flake8 lobster/ || echo "Flake8 linting completed with issues"
        else
          echo "No linting tools found, installing and running basic checks..."
          pip install ruff
          ruff check lobster/ || echo "Ruff linting completed with issues"
        fi
        
        # Basic format check with black if available
        if command -v black &> /dev/null; then
          echo "Checking code formatting..."
          black --check lobster/ || echo "Code formatting check completed with issues"
        elif pip show black &> /dev/null; then
          black --check lobster/ || echo "Code formatting check completed with issues"
        fi
    
    - name: Run unit/config tests
      run: |
        python -m pytest tests/unit/config \
          --maxfail=10 \
          --cov=lobster \
          --cov-report=xml \
          --cov-report=term \
          --junit-xml=test-results.xml \
          --durations=10 \
          -v
    
    - name: Run unit/backend tests
      run: |
        python -m pytest tests/unit/core/backends \
          --maxfail=10 \
          --cov=lobster \
          --cov-report=xml \
          --cov-report=term \
          --junit-xml=test-results.xml \
          --durations=10 \
          -v
    
    - name: Run unit/core/client tests
      run: |
        python -m pytest tests/unit/core/test_client.py \
          --maxfail=10 \
          --cov=lobster \
          --cov-report=xml \
          --cov-report=term \
          --junit-xml=test-results.xml \
          --durations=10 \
          -v
    
    - name: Run unit/core/schemas tests
      run: |
        python -m pytest tests/unit/core/test_schemas.py \
          --maxfail=10 \
          --cov=lobster \
          --cov-report=xml \
          --cov-report=term \
          --junit-xml=test-results.xml \
          --durations=10 \
          -v
    
    - name: Run unit/core/data_manager tests
      run: |
        python -m pytest tests/unit/core/test_data_manager_v2.py \
          --maxfail=10 \
          --cov=lobster \
          --cov-report=xml \
          --cov-report=term \
          --junit-xml=test-results.xml \
          --durations=10 \
          -v
    
    - name: Run unit/agents/test_agent_registry tests
      run: |
        python -m pytest tests/unit/agents/test_agent_registry.py \
          --maxfail=10 \
          --cov=lobster \
          --cov-report=xml \
          --cov-report=term \
          --junit-xml=test-results.xml \
          --durations=10 \
          -v
    
    - name: Run unit/agents/supervisor tests
      env:
        AWS_BEDROCK_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_ACCESS_KEY }}
        AWS_BEDROCK_SECRET_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_SECRET_ACCESS_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
      run: |
        python -m pytest tests/unit/agents/test_supervisor.py \
          --maxfail=10 \
          --cov=lobster \
          --cov-report=xml \
          --cov-report=term \
          --junit-xml=test-results.xml \
          --durations=10 \
          -v
    
    - name: Run tests/unit/agents/test_singlecell_expert.py tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AWS_BEDROCK_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_ACCESS_KEY }}
        AWS_BEDROCK_SECRET_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_SECRET_ACCESS_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
      run: |
        python -m pytest tests/unit/agents/test_singlecell_expert.py \
          --maxfail=10 \
          --cov=lobster \
          --cov-report=xml \
          --cov-report=term \
          --junit-xml=test-results.xml \
          --durations=10 \
          -v
    
    - name: Run tests/unit/agents/test_research_agent.py tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AWS_BEDROCK_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_ACCESS_KEY }}
        AWS_BEDROCK_SECRET_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_SECRET_ACCESS_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
      run: |
        python -m pytest tests/unit/agents/test_research_agent.py \
          --maxfail=10 \
          --cov=lobster \
          --cov-report=xml \
          --cov-report=term \
          --junit-xml=test-results.xml \
          --durations=10 \
          -v
    
    - name: Run tests/unit/agents/test_data_expert tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AWS_BEDROCK_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_ACCESS_KEY }}
        AWS_BEDROCK_SECRET_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_SECRET_ACCESS_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
      run: |
        python -m pytest tests/unit/agents/test_data_expert.py \
          --maxfail=10 \
          --cov=lobster \
          --cov-report=xml \
          --cov-report=term \
          --junit-xml=test-results.xml \
          --durations=10 \
          -v
    
    - name: Run tests/unit/agents/test_method_expert tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AWS_BEDROCK_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_ACCESS_KEY }}
        AWS_BEDROCK_SECRET_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_SECRET_ACCESS_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
      run: |
        python -m pytest tests/unit/agents/test_method_expert.py \
          --maxfail=10 \
          --cov=lobster \
          --cov-report=xml \
          --cov-report=term \
          --junit-xml=test-results.xml \
          --durations=10 \
          -v

  # =====================================================================
  # Basic Security Scan
  # =====================================================================
  security-scan:
    name: Basic Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: 3.12
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
    
    - name: Run safety check
      run: |
        pip install -e .
        safety check || echo "Safety check completed with warnings"
    
    - name: Run bandit security scan
      run: |
        bandit -r lobster/ -f txt || echo "Bandit scan completed with warnings"

  # =====================================================================
  # Build Verification
  # =====================================================================
  build-test:
    name: Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: 3.12
    
    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Build package
      run: python -m build
    
    - name: Verify package
      run: |
        twine check dist/*
        pip install dist/*.whl
        python -c "import lobster; print(f'✅ Package installed successfully')"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 7

  # =====================================================================
  # Integration Tests (Optional)
  # =====================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [quality-and-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: 3.12
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run integration tests (excluding real API tests)
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AWS_BEDROCK_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_ACCESS_KEY }}
        AWS_BEDROCK_SECRET_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_SECRET_ACCESS_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
      run: |
        if [ -d "tests/integration" ]; then
          python -m pytest tests/integration/ \
            -m "integration and not real_api" \
            --maxfail=5 \
            --timeout=300 \
            --cov=lobster \
            --cov-report=xml:coverage-integration.xml \
            --cov-report=term \
            --junit-xml=integration-results.xml \
            --durations=10 \
            -v
        else
          echo "No integration tests found, skipping"
        fi
    
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: integration-results.xml
        retention-days: 30

  # =====================================================================
  # Summary
  # =====================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [quality-and-tests, security-scan, build-test, integration-tests]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "## CI Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Code Quality & Tests: ${{ needs.quality-and-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build Test: ${{ needs.build-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.quality-and-tests.result }}" == "success" && 
              "${{ needs.security-scan.result }}" == "success" && 
              "${{ needs.build-test.result }}" == "success" ]]; then
          echo "- **Overall Status: ✅ PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Overall Status: ❌ FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
