# =============================================================================
# PUBLIC REPOSITORY RELEASE WORKFLOW (lobster-local)
# =============================================================================
# This workflow runs IN lobster-local when a tag is pushed.
# It creates GitHub releases using the repo's native GITHUB_TOKEN.
#
# Architecture:
#   1. Private repo (lobster) pushes tag via deploy key
#   2. This workflow triggers in lobster-local
#   3. Builds package and creates release with native auth
#   4. No PAT required - uses ${{ github.token }}
#
# Synced from: lobster/.github/workflows/public-release.yml
# =============================================================================

name: Create Public Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  PACKAGE_NAME: lobster-ai

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write  # Required for gh release create

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for version detection

    - name: Extract version
      id: version
      run: |
        VERSION="${GITHUB_REF#refs/tags/}"
        VERSION_NUM="${VERSION#v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=$VERSION_NUM" >> $GITHUB_OUTPUT
        echo "Building release for version: $VERSION"

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        echo "Building package..."
        python -m build

        echo "Build artifacts:"
        ls -lh dist/

        # Verify package
        twine check dist/*

    - name: Verify package size
      run: |
        SIZE=$(du -sm dist/*.whl | cut -f1)
        echo "Package size: ${SIZE}MB"

        if [ $SIZE -gt 500 ]; then
          echo "WARNING: Package larger than expected (${SIZE}MB)"
        fi

    - name: Generate release notes
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        VERSION_NUM="${{ steps.version.outputs.version_number }}"

        cat > release_notes.md << 'EOF'
        # Lobster AI ${{ steps.version.outputs.version }}

        ## Installation

        ### From PyPI (Recommended)

        ```bash
        pip install lobster-ai==${{ steps.version.outputs.version_number }}
        ```

        ### From GitHub Release

        ```bash
        pip install https://github.com/the-omics-os/lobster-local/releases/download/${{ steps.version.outputs.version }}/lobster_ai-${{ steps.version.outputs.version_number }}-py3-none-any.whl
        ```

        ## Package Information

        - **Package Name**: lobster-ai
        - **Version**: ${{ steps.version.outputs.version_number }}
        - **Python**: 3.11+
        - **License**: AGPL-3.0-or-later

        ## Links

        - **PyPI**: https://pypi.org/project/lobster-ai/${{ steps.version.outputs.version_number }}/
        - **Documentation**: https://github.com/the-omics-os/lobster-local/wiki
        - **Source**: https://github.com/the-omics-os/lobster-local

        ---
        *Automated release via GitHub Actions*
        EOF

    - name: Create GitHub Release
      env:
        GH_TOKEN: ${{ github.token }}  # Native token - no PAT needed
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        # Determine if prerelease
        PRERELEASE_FLAG=""
        if [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]]; then
          PRERELEASE_FLAG="--prerelease"
          echo "Creating pre-release..."
        fi

        # Create release with artifacts
        gh release create "$VERSION" \
          --title "Release $VERSION" \
          --notes-file release_notes.md \
          $PRERELEASE_FLAG \
          dist/*.whl \
          dist/*.tar.gz

        echo "Release created: https://github.com/${{ github.repository }}/releases/tag/$VERSION"

    - name: Generate summary
      run: |
        echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Package**: ${{ env.PACKAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **PyPI**: https://pypi.org/project/${{ env.PACKAGE_NAME }}/${{ steps.version.outputs.version_number }}/" >> $GITHUB_STEP_SUMMARY
        echo "- **Release**: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
