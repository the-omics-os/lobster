name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0 - without v prefix)'
        required: true
        type: string

env:
  PYTHONPATH: ${{ github.workspace }}

jobs:
  # =====================================================================
  # Build and Test Package
  # =====================================================================
  build:
    name: Build Package
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history needed for setuptools-scm

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: 3.12
        cache: 'pip'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine setuptools-scm

    - name: Verify version from tag
      if: github.event_name == 'push'
      run: |
        TAG_VERSION="${GITHUB_REF#refs/tags/v}"
        echo "Building version from tag: $TAG_VERSION"

        # Verify setuptools-scm can read the version
        python -m setuptools_scm

    - name: Build package
      run: |
        echo "Building package..."
        python -m build

        echo "Build artifacts:"
        ls -lh dist/

    - name: Verify package integrity
      run: |
        echo "Checking package with twine..."
        twine check dist/*

        echo "Inspecting wheel contents..."
        unzip -l dist/*.whl | head -50

    - name: Test installation
      run: |
        echo "Testing package installation (excluding heavy docling/torch deps for CI)..."

        # Step 1: Install the wheel itself, without its dependencies.
        # This places the lobster package itself in site-packages.
        pip install dist/*.whl --no-deps

        # Step 2: Extract dependencies from the wheel, filter out heavy ones, and install the rest.
        # WORKAROUND: docling â†’ accelerate â†’ torch chain pulls 5GB+ CUDA packages
        # This causes "No space left on device" in GitHub Actions (14GB disk limit)
        # Solution: Use grep to filter out heavy packages before installing
        DEPS_TO_INSTALL=$(unzip -p dist/*.whl */METADATA | \
            grep "^Requires-Dist:" | \
            grep -v "extra ==" | \
            grep -iv "docling" | \
            grep -iv "torch" | \
            grep -iv "accelerate" | \
            sed 's/Requires-Dist: //' | \
            tr '\n' ' ')

        if [ -n "$DEPS_TO_INSTALL" ]; then
            pip install $DEPS_TO_INSTALL
        else
            echo "No dependencies to install."
        fi

        # Step 3: Verify core functionality is available.
        # This confirms the package is importable and the CLI entrypoint works.
        echo "Verifying installation..."
        python -c "import lobster; print(f'âœ… Lobster version: {lobster.__version__}')"
        lobster --help

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: dist/
        retention-days: 30

  # =====================================================================
  # Run Tests Before Release
  # =====================================================================
  test:
    name: Pre-release Tests
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: 3.12
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run unit tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AWS_BEDROCK_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_ACCESS_KEY }}
        AWS_BEDROCK_SECRET_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_SECRET_ACCESS_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
      run: |
        if [ -d "tests/unit" ]; then
          python -m pytest tests/unit/ \
            --maxfail=5 \
            --cov=lobster \
            --cov-report=term \
            -v
        else
          echo "No unit tests found, skipping"
        fi

    - name: Run integration tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AWS_BEDROCK_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_ACCESS_KEY }}
        AWS_BEDROCK_SECRET_ACCESS_KEY: ${{ secrets.AWS_BEDROCK_SECRET_ACCESS_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
      run: |
        if [ -d "tests/integration" ]; then
          python -m pytest tests/integration/ \
            --maxfail=3 \
            --timeout=300 \
            -v
        else
          echo "No integration tests found, skipping"
        fi

  # =====================================================================
  # Create GitHub Release with Built Packages
  # =====================================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, test]
    timeout-minutes: 10

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-packages
        path: dist/

    - name: Verify artifacts
      run: |
        echo "Distribution artifacts to attach to release:"
        ls -lh dist/

        # Count artifacts
        wheel_count=$(ls dist/*.whl 2>/dev/null | wc -l)
        tar_count=$(ls dist/*.tar.gz 2>/dev/null | wc -l)

        echo "Wheels: $wheel_count"
        echo "Source distributions: $tar_count"

        if [ $wheel_count -eq 0 ] || [ $tar_count -eq 0 ]; then
          echo "âŒ Missing distribution artifacts!"
          exit 1
        fi

    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="v${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

    - name: Generate release notes
      id: notes
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        VERSION_NUM="${{ steps.version.outputs.version_number }}"

        cat > release_notes.md << 'EOF'
        # Lobster AI ${{ steps.version.outputs.version }}

        ## ðŸ“¦ Installation

        ### From GitHub Release (Recommended for lobster-cloud)

        ```bash
        # Download wheel from this release
        wget https://github.com/the-omics-os/lobster/releases/download/${{ steps.version.outputs.version }}/lobster-${{ steps.version.outputs.version_number }}-py3-none-any.whl
        pip install lobster-${{ steps.version.outputs.version_number }}-py3-none-any.whl
        ```

        ### From Git Tag

        ```bash
        # Install specific version
        pip install git+https://github.com/the-omics-os/lobster.git@${{ steps.version.outputs.version }}

        # Or in pyproject.toml/requirements.txt
        lobster @ git+https://github.com/the-omics-os/lobster.git@${{ steps.version.outputs.version }}
        ```

        ### From Main Branch (Latest)

        ```bash
        pip install git+https://github.com/the-omics-os/lobster.git@main
        ```

        ## ðŸ“‹ Package Information

        - **Version**: ${{ steps.version.outputs.version_number }}
        - **Python**: 3.12+
        - **Type**: Private Package (GitHub Distribution Only)

        ## ðŸ”„ What's New

        See [CHANGELOG.md](https://github.com/the-omics-os/lobster/blob/main/CHANGELOG.md) for detailed changes.

        ## ðŸ—ï¸ For lobster-cloud Integration

        Update your `pyproject.toml`:
        ```toml
        dependencies = [
            "lobster @ git+https://github.com/the-omics-os/lobster.git@${{ steps.version.outputs.version }}",
            # ... other dependencies
        ]
        ```

        ---

        ðŸ“¦ *Built and released automatically via GitHub Actions*
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Release ${{ steps.version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
        files: |
          dist/*.whl
          dist/*.tar.gz

  # =====================================================================
  # Post-release Verification
  # =====================================================================
  verify:
    name: Post-release Verification
    runs-on: ubuntu-latest
    needs: [release]
    timeout-minutes: 10

    steps:
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: 3.12

    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="v${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Install from Git Tag
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        echo "Installing lobster from Git tag $VERSION..."
        pip install git+https://github.com/the-omics-os/lobster.git@$VERSION

    - name: Verify installation
      run: |
        echo "Verifying package installation..."

        # Check version
        python -c "import lobster; print(f'Installed version: {lobster.__version__}')"

        # Check CLI
        lobster --help

        # Check key imports
        python -c "from lobster.core import AgentClient"
        python -c "from lobster.config import AgentRegistry"

        echo "âœ… Package successfully released and verified!"

  # =====================================================================
  # Release Summary
  # =====================================================================
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [build, test, release, verify]
    if: always()

    steps:
    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="v${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Generate release summary
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        echo "## ðŸ“¦ Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- **Build**: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release**: ${{ needs.release.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Verification**: ${{ needs.verify.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ needs.build.result }}" == "success" &&
              "${{ needs.test.result }}" == "success" &&
              "${{ needs.release.result }}" == "success" &&
              "${{ needs.verify.result }}" == "success" ]]; then
          echo "### âœ… Release Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release is now available at:" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub: https://github.com/${{ github.repository }}/releases/tag/$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install with:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install git+https://github.com/${{ github.repository }}.git@$VERSION" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Release Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the job outputs above for details." >> $GITHUB_STEP_SUMMARY
        fi