---
phase: 02-service-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lobster/core/vector/ontology_graph.py
  - tests/unit/core/vector/test_ontology_graph.py
autonomous: true
requirements: [GRPH-01, GRPH-02, GRPH-03]

must_haves:
  truths:
    - "load_ontology_graph('mondo') returns a NetworkX MultiDiGraph when obonet is installed"
    - "get_neighbors() returns parent/child/sibling dicts for any ontology term ID"
    - "OBO_URLS covers mondo, uberon, and cell_ontology"
    - "ImportError with helpful message when obonet not installed"
    - "Graph is cached for process lifetime via lru_cache"
  artifacts:
    - path: "lobster/core/vector/ontology_graph.py"
      provides: "Ontology graph loading and traversal"
      contains: "load_ontology_graph"
    - path: "tests/unit/core/vector/test_ontology_graph.py"
      provides: "Unit tests for ontology graph module"
      contains: "test_load_ontology_graph"
  key_links:
    - from: "lobster/core/vector/ontology_graph.py"
      to: "obonet"
      via: "import-guarded obonet.read_obo()"
      pattern: "import obonet"
    - from: "lobster/core/vector/ontology_graph.py"
      to: "networkx"
      via: "graph.successors/predecessors for traversal"
      pattern: "graph\\.successors|graph\\.predecessors"
---

<objective>
Create the ontology graph module providing OBO file parsing and graph traversal for MONDO, Uberon, and Cell Ontology.

Purpose: Agents need parent/child/sibling context for ontology terms (e.g., "colorectal cancer IS_A intestinal cancer"). This module provides that infrastructure independently from vector search.
Output: `ontology_graph.py` with load_ontology_graph(), get_neighbors(), OBO_URLS + comprehensive unit tests
</objective>

<execution_context>
@/Users/tyo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tyo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-service-integration/02-RESEARCH.md
@lobster/core/vector/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ontology_graph.py with load_ontology_graph() and get_neighbors()</name>
  <files>lobster/core/vector/ontology_graph.py</files>
  <action>
Create `lobster/core/vector/ontology_graph.py` with three components:

1. **OBO_URLS constant** (GRPH-03): Dict mapping ontology names to OBO Foundry download URLs:
   - `"mondo"` -> `"https://purl.obolibrary.org/obo/mondo.obo"`
   - `"uberon"` -> `"https://purl.obolibrary.org/obo/uberon/uberon-basic.obo"`
   - `"cell_ontology"` -> `"https://purl.obolibrary.org/obo/cl.obo"`

2. **load_ontology_graph(ontology: str) -> nx.MultiDiGraph** (GRPH-01):
   - Decorated with `@lru_cache(maxsize=3)` for process-lifetime caching
   - Import-guards `obonet` inside the function body (not module level) with helpful error message: `"Ontology graph requires obonet. Install with: pip install 'lobster-ai[vector-search]'"`
   - Validates ontology name against OBO_URLS keys, raises ValueError with available options if unknown
   - Calls `obonet.read_obo(url)` to load and parse OBO file
   - Logs info before and after loading with term/edge counts
   - Returns the networkx.MultiDiGraph directly

3. **get_neighbors(graph, term_id, depth=1, relation="all") -> dict** (GRPH-02):
   - Import `networkx as nx` inside the function body
   - Return `{"parents": [...], "children": [...], "siblings": [...]}` where each entry is a list of `{"term_id": str, "name": str}` dicts
   - Handle missing term_id gracefully: return empty dicts for all three keys
   - CRITICAL edge direction: OBO edges go FROM child TO parent (is_a). Therefore:
     - Parents (depth=1): `graph.successors(term_id)` — follow edges forward
     - Parents (depth>1): `nx.descendants(graph, term_id)` — transitive parents
     - Children (depth=1): `graph.predecessors(term_id)` — follow edges backward
     - Children (depth>1): `nx.ancestors(graph, term_id)` — transitive children
     - Siblings: other children of immediate parents (always depth=1 for siblings)
   - Helper `_format_term(graph, tid)` extracts `{"term_id": tid, "name": graph.nodes[tid].get("name", "")}`
   - Comment the edge direction convention clearly in the docstring

Use `from __future__ import annotations` and TYPE_CHECKING guard for networkx type hints (consistent with Phase 1 patterns). Use `from lobster.utils.logger import get_logger` for logging.
  </action>
  <verify>
Run: `python -c "from lobster.core.vector.ontology_graph import OBO_URLS, load_ontology_graph, get_neighbors; print('OBO_URLS:', list(OBO_URLS.keys())); print('Imports OK')"` -- should print the 3 ontology names without importing obonet.
  </verify>
  <done>
ontology_graph.py exists with load_ontology_graph(), get_neighbors(), and OBO_URLS. Imports work without obonet installed. OBO_URLS has exactly 3 entries (mondo, uberon, cell_ontology).
  </done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for ontology graph module</name>
  <files>tests/unit/core/vector/test_ontology_graph.py</files>
  <action>
Create `tests/unit/core/vector/test_ontology_graph.py` with comprehensive tests using mocked obonet (no real network calls).

**Test structure (5 test classes):**

1. **TestOBOUrls** (GRPH-03):
   - `test_obo_urls_has_mondo` — "mondo" key exists with correct URL
   - `test_obo_urls_has_uberon` — "uberon" key exists with correct URL
   - `test_obo_urls_has_cell_ontology` — "cell_ontology" key exists with correct URL
   - `test_obo_urls_exactly_three_entries` — dict has exactly 3 entries

2. **TestLoadOntologyGraph** (GRPH-01):
   - `test_load_unknown_ontology_raises_value_error` — ValueError with available options
   - `test_load_missing_obonet_raises_import_error` — ImportError with pip install message (mock `builtins.__import__` to simulate obonet missing)
   - `test_load_calls_obonet_read_obo` — mock obonet.read_obo, verify called with correct URL
   - `test_load_returns_graph` — mock obonet.read_obo returning a mock MultiDiGraph, verify type

3. **TestGetNeighbors** (GRPH-02):
   Create a small test MultiDiGraph fixture:
   ```
   # OBO direction: child -> parent (is_a)
   # grandparent <- parent1, parent2 <- child1, child2, child3
   graph.add_edge("child1", "parent1")     # child1 is_a parent1
   graph.add_edge("child2", "parent1")     # child2 is_a parent1
   graph.add_edge("child3", "parent2")     # child3 is_a parent2
   graph.add_edge("parent1", "grandparent") # parent1 is_a grandparent
   graph.add_edge("parent2", "grandparent") # parent2 is_a grandparent
   # Add node names
   graph.nodes["child1"]["name"] = "Child One"
   # ... etc for all nodes
   ```
   - `test_parents_depth_1` — child1's parents include parent1 only
   - `test_children_depth_1` — parent1's children include child1 and child2
   - `test_siblings` — child1's siblings include child2 (but not child1 itself)
   - `test_parents_depth_2` — child1 with depth=2 returns parent1 AND grandparent
   - `test_missing_term_returns_empty` — unknown term returns empty lists
   - `test_format_includes_name` — returned dicts have "term_id" and "name" keys

4. **TestLruCache** (GRPH-01 caching):
   - `test_load_ontology_graph_cached` — mock obonet.read_obo, call load_ontology_graph twice with same arg, verify read_obo called only once. Clear cache with `load_ontology_graph.cache_clear()` in fixture teardown.

5. **TestEdgeCases**:
   - `test_get_neighbors_leaf_node` — node with no children returns empty children list
   - `test_get_neighbors_root_node` — node with no parents returns empty parents list

Use `unittest.mock.patch` for mocking obonet. Use `networkx.MultiDiGraph()` directly for the test graph fixture (networkx IS available in dev environment).
  </action>
  <verify>
Run: `cd /Users/tyo/omics-os/lobster && python -m pytest tests/unit/core/vector/test_ontology_graph.py -v` — all tests should pass.
  </verify>
  <done>
All ontology graph tests pass. Tests cover OBO_URLS completeness, load_ontology_graph error handling and caching, get_neighbors parent/child/sibling traversal, and edge cases for leaf/root nodes.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from lobster.core.vector.ontology_graph import OBO_URLS; assert len(OBO_URLS) == 3"` passes
2. `python -m pytest tests/unit/core/vector/test_ontology_graph.py -v` — all tests pass
3. No heavy imports at module level (obonet/networkx only imported inside functions)
4. OBO_URLS has exactly 3 entries: mondo, uberon, cell_ontology
</verification>

<success_criteria>
- ontology_graph.py provides load_ontology_graph(), get_neighbors(), OBO_URLS
- All unit tests pass with mocked obonet (no network calls)
- Import-guarded: importing module does not require obonet
- lru_cache caches graph for process lifetime
- Edge direction documented and correct (children -> parents in OBO)
</success_criteria>

<output>
After completion, create `.planning/phases/02-service-integration/02-01-SUMMARY.md`
</output>
