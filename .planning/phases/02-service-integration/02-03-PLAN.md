---
phase: 02-service-integration
plan: 03
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - packages/lobster-metadata/lobster/services/metadata/disease_ontology_service.py
  - packages/lobster-metadata/lobster/services/metadata/disease_standardization_service.py
  - packages/lobster-metadata/tests/services/metadata/test_disease_ontology_service.py
  - lobster/config/disease_ontology.json
autonomous: true
requirements: [MIGR-01, MIGR-02, MIGR-03, MIGR-04, MIGR-05, MIGR-06, TEST-06]

must_haves:
  truths:
    - "DiseaseOntologyService with backend='json' uses keyword matching (existing behavior unchanged)"
    - "DiseaseOntologyService with backend='embeddings' delegates to VectorSearchService.match_ontology('mondo')"
    - "_convert_ontology_match() maps OntologyMatch fields to DiseaseMatch correctly"
    - "When backend='embeddings' but vector deps not installed, falls back to keyword with logger.warning"
    - "DiseaseStandardizationService logs warning on ImportError instead of silent fallback"
    - "lobster/config/disease_ontology.json is deleted (canonical stays in lobster-metadata)"
    - "All existing DiseaseOntologyService tests still pass (keyword path unchanged)"
  artifacts:
    - path: "packages/lobster-metadata/lobster/services/metadata/disease_ontology_service.py"
      provides: "Backend branching and vector search delegation"
      contains: "_convert_ontology_match"
    - path: "packages/lobster-metadata/lobster/services/metadata/disease_standardization_service.py"
      provides: "Fixed silent fallback with logger.warning"
      contains: "logger.warning"
    - path: "packages/lobster-metadata/tests/services/metadata/test_disease_ontology_service.py"
      provides: "Tests for both keyword and embeddings backend paths"
      contains: "TestBackendSwitching"
  key_links:
    - from: "packages/lobster-metadata/lobster/services/metadata/disease_ontology_service.py"
      to: "lobster/core/vector/service.py"
      via: "lazy import of VectorSearchService in __init__"
      pattern: "from lobster\\.core\\.vector\\.service import VectorSearchService"
    - from: "packages/lobster-metadata/lobster/services/metadata/disease_ontology_service.py"
      to: "lobster/core/schemas/search.py"
      via: "OntologyMatch type used in _convert_ontology_match"
      pattern: "OntologyMatch"
    - from: "packages/lobster-metadata/lobster/services/metadata/disease_standardization_service.py"
      to: "logger.warning"
      via: "explicit warning on ImportError fallback"
      pattern: "logger\\.warning.*not available"
---

<objective>
Complete the Strangler Fig migration of DiseaseOntologyService to branch on backend="embeddings" vs "json", fix silent fallback in DiseaseStandardizationService, delete duplicate config file, and add comprehensive tests.

Purpose: This is the migration payoff — DiseaseOntologyService gains semantic matching via VectorSearchService delegation while preserving the exact match_disease() API contract. Callers don't change, but matching quality jumps from keyword substring to embedding-based similarity. The duplicate config file and silent fallback are cleaned up as part of the migration.
Output: Modified DiseaseOntologyService with backend branching, fixed DiseaseStandardizationService, deleted duplicate config, new tests
</objective>

<execution_context>
@/Users/tyo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tyo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-service-integration/02-RESEARCH.md
@.planning/phases/02-service-integration/02-02-SUMMARY.md
@packages/lobster-metadata/lobster/services/metadata/disease_ontology_service.py
@packages/lobster-metadata/lobster/services/metadata/disease_standardization_service.py
@packages/lobster-metadata/tests/services/metadata/test_disease_ontology_service.py
@lobster/core/schemas/ontology.py
@lobster/core/schemas/search.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backend branching to DiseaseOntologyService and fix silent fallback</name>
  <files>
    packages/lobster-metadata/lobster/services/metadata/disease_ontology_service.py
    packages/lobster-metadata/lobster/services/metadata/disease_standardization_service.py
    lobster/config/disease_ontology.json
  </files>
  <action>
**Modify `disease_ontology_service.py`** to add backend branching (MIGR-01, MIGR-02, MIGR-03, MIGR-04):

1. In `__init__()`, AFTER existing JSON loading, add vector backend initialization:
   ```python
   # Phase 2: Initialize vector backend if configured
   self._vector_service = None
   if self._config.backend == "embeddings":
       try:
           from lobster.core.vector.service import VectorSearchService
           self._vector_service = VectorSearchService()
           logger.info("DiseaseOntologyService using embeddings backend")
       except ImportError:
           logger.warning(
               "Vector search deps not installed, falling back to keyword matching. "
               "Install with: pip install 'lobster-ai[vector-search]'"
           )
           # Fall through to keyword path (self._vector_service remains None)
   ```
   Place this AFTER `self._config = self._load_from_json(config_path)` and BEFORE `self._diseases = self._config.diseases`. Always build keyword index (needed for fallback).

2. In `match_disease()`, add vector delegation BEFORE the existing keyword logic (MIGR-02):
   ```python
   # Phase 2: Delegate to vector search if available
   if self._vector_service is not None:
       ontology_matches = self._vector_service.match_ontology(query, "mondo", k=k)
       disease_matches = [
           self._convert_ontology_match(m, query) for m in ontology_matches
       ]
       return [m for m in disease_matches if m.confidence >= min_confidence]
   ```
   The existing keyword path code stays unchanged below this block as the fallback.

3. Add `_convert_ontology_match()` method (MIGR-03, SCHM-03):
   ```python
   def _convert_ontology_match(self, match, original_query: str) -> DiseaseMatch:
       """Convert OntologyMatch to DiseaseMatch (SCHM-03 compatibility)."""
       return DiseaseMatch(
           disease_id=match.ontology_id,         # "MONDO:0005575"
           name=match.term,                       # "colorectal carcinoma"
           confidence=match.score,                # 0.0-1.0
           match_type="semantic_embedding",       # Phase 2 indicator
           matched_term=original_query,           # original user query
           metadata=match.metadata,               # extensible metadata
       )
   ```
   Import OntologyMatch lazily (TYPE_CHECKING guard) — the actual OntologyMatch objects come from VectorSearchService so no runtime import needed for the type.

**Modify `disease_standardization_service.py`** to fix silent fallback (MIGR-05):

At lines 18-27, add logger.warning to the except ImportError block:
```python
try:
    from lobster.services.metadata.disease_ontology_service import (
        DiseaseOntologyService,
    )
    HAS_ONTOLOGY_SERVICE = True
except ImportError:
    HAS_ONTOLOGY_SERVICE = False
    logger.warning(
        "DiseaseOntologyService not available, using hardcoded disease mappings. "
        "Install lobster-metadata for centralized ontology management."
    )
```

**Delete duplicate config file** (MIGR-06):

Delete `lobster/config/disease_ontology.json`. The canonical copy stays at `packages/lobster-metadata/lobster/config/disease_ontology.json`. Use `git rm` to track the deletion.

IMPORTANT: Do NOT modify the canonical disease_ontology.json in lobster-metadata. The `backend` field stays as `"json"` — switching to `"embeddings"` is a runtime/config decision for users, not a default change.
  </action>
  <verify>
1. Run: `python -c "from lobster.services.metadata.disease_ontology_service import DiseaseOntologyService; s = DiseaseOntologyService(); print(s.match_disease('crc'))"` — should still return keyword match (backend="json" in config)
2. Verify `lobster/config/disease_ontology.json` no longer exists
3. Run existing tests: `cd /Users/tyo/omics-os/lobster && python -m pytest packages/lobster-metadata/tests/services/metadata/test_disease_ontology_service.py -v` — all existing tests pass unchanged
  </verify>
  <done>
DiseaseOntologyService branches on config.backend. When backend="json", keyword matching works identically to before. When backend="embeddings", delegates to VectorSearchService.match_ontology("mondo"). Silent fallback in DiseaseStandardizationService fixed with logger.warning. Duplicate disease_ontology.json deleted from lobster/config/. All existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write tests for backend switching, converter, and fallback behavior</name>
  <files>packages/lobster-metadata/tests/services/metadata/test_disease_ontology_service.py</files>
  <action>
Add new test classes to the existing `test_disease_ontology_service.py` for Phase 2 backend branching (TEST-06).

**New test class `TestBackendSwitching`** (MIGR-01, MIGR-02):

Create a helper fixture that patches DiseaseOntologyService to use backend="embeddings" with a mock VectorSearchService:

```python
@pytest.fixture
def mock_vector_service():
    """Mock VectorSearchService.match_ontology() for embeddings backend tests."""
    mock_service = MagicMock()
    mock_service.match_ontology.return_value = [
        OntologyMatch(
            term="colorectal carcinoma",
            ontology_id="MONDO:0005575",
            score=0.92,
            metadata={"source": "MONDO"},
            distance_metric="cosine",
        ),
        OntologyMatch(
            term="colon cancer",
            ontology_id="MONDO:0005556",
            score=0.85,
            metadata={"source": "MONDO"},
            distance_metric="cosine",
        ),
    ]
    return mock_service
```

Tests:
- `test_json_backend_uses_keyword_matching` — backend="json" goes through existing keyword path (existing behavior; verify match_type="exact_keyword")
- `test_embeddings_backend_delegates_to_vector_service` — patch VectorSearchService import, set backend="embeddings", verify match_disease() calls vector_service.match_ontology("mondo", ...)
- `test_embeddings_backend_returns_disease_match_objects` — verify return type is List[DiseaseMatch] not List[OntologyMatch]
- `test_embeddings_backend_respects_min_confidence` — with matches at 0.92 and 0.85, min_confidence=0.9 should filter to 1 result
- `test_embeddings_backend_respects_k_parameter` — k=1 should return only 1 result

**New test class `TestConvertOntologyMatch`** (MIGR-03, SCHM-03):
- `test_convert_maps_ontology_id_to_disease_id` — OntologyMatch.ontology_id -> DiseaseMatch.disease_id
- `test_convert_maps_term_to_name` — OntologyMatch.term -> DiseaseMatch.name
- `test_convert_maps_score_to_confidence` — OntologyMatch.score -> DiseaseMatch.confidence
- `test_convert_sets_match_type_semantic_embedding` — DiseaseMatch.match_type == "semantic_embedding"
- `test_convert_sets_matched_term_to_original_query` — DiseaseMatch.matched_term == original query

**New test class `TestFallbackBehavior`** (MIGR-04):
- `test_embeddings_fallback_to_keyword_when_import_fails` — set backend="embeddings", mock VectorSearchService import to raise ImportError, verify keyword matching still works and logger.warning called
- `test_fallback_logs_warning` — verify logger.warning message contains "falling back to keyword"

**New test class `TestDuplicateConfigRemoved`** (MIGR-06):
- `test_core_disease_ontology_json_deleted` — assert `lobster/config/disease_ontology.json` does not exist (Path check)

**New test class `TestSilentFallbackFixed`** (MIGR-05):
- `test_disease_standardization_service_logs_warning_on_import_error` — mock the DiseaseOntologyService import to fail, import disease_standardization_service module, verify logger.warning was called

Import OntologyMatch from `lobster.core.schemas.search` for constructing mock objects. Use `unittest.mock.patch` and `unittest.mock.MagicMock` throughout. For backend="embeddings" tests, create a temporary JSON config with `"backend": "embeddings"` via tmp_path fixture.
  </action>
  <verify>
Run: `cd /Users/tyo/omics-os/lobster && python -m pytest packages/lobster-metadata/tests/services/metadata/test_disease_ontology_service.py -v` — all tests pass (existing + new).
  </verify>
  <done>
All DiseaseOntologyService tests pass. New tests cover: backend="json" keyword path unchanged, backend="embeddings" delegation to VectorSearchService, _convert_ontology_match() field mapping, fallback behavior with logger.warning, duplicate config deletion, and DiseaseStandardizationService silent fallback fix.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest packages/lobster-metadata/tests/services/metadata/test_disease_ontology_service.py -v` — all tests pass
2. `python -c "from lobster.services.metadata.disease_ontology_service import DiseaseOntologyService; s = DiseaseOntologyService(); m = s.match_disease('crc'); print(m[0].match_type)"` — prints "exact_keyword" (default backend=json)
3. `ls lobster/config/disease_ontology.json` — file does NOT exist (deleted)
4. `ls packages/lobster-metadata/lobster/config/disease_ontology.json` — file EXISTS (canonical)
5. `python -m pytest tests/unit/core/vector/ -v` — Phase 1+2 vector tests still pass
</verification>

<success_criteria>
- DiseaseOntologyService.match_disease() returns keyword matches when backend="json" (all existing tests pass)
- DiseaseOntologyService.match_disease() delegates to VectorSearchService.match_ontology("mondo") when backend="embeddings"
- _convert_ontology_match() correctly maps OntologyMatch -> DiseaseMatch fields
- Fallback from embeddings to keyword with explicit logger.warning when vector deps missing
- DiseaseStandardizationService ImportError fallback logs warning instead of being silent
- lobster/config/disease_ontology.json deleted, canonical copy in lobster-metadata preserved
- All tests pass (existing Phase 1, existing disease ontology, new Phase 2)
</success_criteria>

<output>
After completion, create `.planning/phases/02-service-integration/02-03-SUMMARY.md`
</output>
