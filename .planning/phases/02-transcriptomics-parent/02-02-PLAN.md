---
phase: 02-transcriptomics-parent
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - packages/lobster-transcriptomics/lobster/agents/transcriptomics/shared_tools.py
  - packages/lobster-transcriptomics/lobster/agents/transcriptomics/transcriptomics_expert.py
autonomous: true
requirements: [SCT-01, SCT-04, SCT-05, SCT-06, SCT-07, SCT-08]

must_haves:
  truths:
    - "detect_doublets tool wraps EnhancedSingleCellService.detect_doublets and produces _doublets_detected modality"
    - "integrate_batches tool wraps the new service method and returns LISI + silhouette in response text"
    - "compute_trajectory tool wraps the new service method and returns pseudotime range in response text"
    - "filter_and_normalize renamed to filter_and_normalize (drop _modality suffix)"
    - "select_highly_variable_genes renamed to select_variable_features"
    - "cluster_modality renamed to cluster_cells"
    - "find_marker_genes_for_clusters renamed to find_marker_genes"
    - "subcluster_cells no longer throws TypeError when clusters_to_refine is None"
  artifacts:
    - path: "packages/lobster-transcriptomics/lobster/agents/transcriptomics/shared_tools.py"
      provides: "Renamed filter_and_normalize and select_variable_features tools"
      contains: "def filter_and_normalize"
    - path: "packages/lobster-transcriptomics/lobster/agents/transcriptomics/transcriptomics_expert.py"
      provides: "3 new SC tools + 2 renames + bug fix"
      contains: "def detect_doublets"
  key_links:
    - from: "transcriptomics_expert.py"
      to: "enhanced_singlecell_service.py"
      via: "detect_doublets, integrate_batches, compute_trajectory service calls"
      pattern: "enhanced_service\\.(detect_doublets|integrate_batches|compute_trajectory)"
    - from: "transcriptomics_expert.py"
      to: "data_manager.log_tool_usage"
      via: "ir=ir on every tool"
      pattern: "ir=ir"
---

<objective>
Wire 3 new single-cell tools (detect_doublets, integrate_batches, compute_trajectory), rename 4 tools for clarity, and fix BUG-01 in subcluster_cells.

Purpose: These changes give the SC transcriptomics pipeline doublet detection, batch integration with quality metrics, and trajectory inference — the three most-requested missing capabilities. Renames reduce LLM confusion by removing verbose suffixes.

Output: transcriptomics_expert.py with 3 new tools + 2 renamed tools, shared_tools.py with 2 renamed tools, BUG-01 fixed.
</objective>

<execution_context>
@/Users/tyo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tyo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-transcriptomics-parent/02-RESEARCH.md
@.planning/phases/02-transcriptomics-parent/02-01-SUMMARY.md

# Key source files
@packages/lobster-transcriptomics/lobster/agents/transcriptomics/transcriptomics_expert.py
@packages/lobster-transcriptomics/lobster/agents/transcriptomics/shared_tools.py
@packages/lobster-transcriptomics/lobster/agents/transcriptomics/prompts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename 4 tools and fix BUG-01 in subcluster_cells</name>
  <files>
    packages/lobster-transcriptomics/lobster/agents/transcriptomics/shared_tools.py
    packages/lobster-transcriptomics/lobster/agents/transcriptomics/transcriptomics_expert.py
  </files>
  <action>
**Renames in shared_tools.py** (SCT-04, SCT-05):

1. **SCT-04: Rename `filter_and_normalize_modality` to `filter_and_normalize`** (line ~321):
   - Rename the `def filter_and_normalize_modality(` function to `def filter_and_normalize(`
   - Update the `tool_name=` string in `data_manager.log_tool_usage()` from `"filter_and_normalize_modality"` to `"filter_and_normalize"`
   - Update any response text referencing the old name

2. **SCT-05: Rename `select_highly_variable_genes` to `select_variable_features`** (line ~657):
   - Rename the `def select_highly_variable_genes(` function to `def select_variable_features(`
   - Update the `tool_name=` string in `data_manager.log_tool_usage()` to `"select_variable_features"`
   - Update any response text referencing the old name

**Renames in transcriptomics_expert.py** (SCT-06, SCT-07):

3. **SCT-06: Rename `cluster_modality` to `cluster_cells`** (line ~131):
   - Rename the `def cluster_modality(` function to `def cluster_cells(`
   - Update `tool_name="cluster_modality"` to `"cluster_cells"` in log_tool_usage
   - Update response text references (e.g., "Next steps: find_marker_genes_for_clusters()" becomes "find_marker_genes()")

4. **SCT-07: Rename `find_marker_genes_for_clusters` to `find_marker_genes`** (line ~755):
   - Rename the `def find_marker_genes_for_clusters(` function to `def find_marker_genes(`
   - Update `tool_name="find_marker_genes_for_clusters"` to `"find_marker_genes"` in log_tool_usage
   - Update any self-references in response text

5. **Update the `clustering_tools` list** (line ~934): Replace old names with new:
   ```python
   clustering_tools = [
       cluster_cells,          # was cluster_modality
       subcluster_cells,
       evaluate_clustering_quality,
       find_marker_genes,      # was find_marker_genes_for_clusters
   ]
   ```

**BUG-01 Fix in transcriptomics_expert.py** (SCT-08):

6. In `subcluster_cells` tool (line ~398-418), the `len(clusters_to_refine)` call crashes when `clusters_to_refine` is None. Fix BOTH locations:
   - Compute once at the top of the try block:
     ```python
     n_refined = len(clusters_to_refine) if clusters_to_refine else "all"
     ```
   - Replace `len(clusters_to_refine)` with `n_refined` in:
     - `step_summary=f"Subclustered {n_refined} clusters from {cluster_key}"` (~line 403)
     - `description=f"Subclustered {n_refined} clusters from {cluster_key}"` (~line 418)
   - Also fix `len(stats["parent_clusters"])` usage in response text — this should be safe since stats always has parent_clusters, but verify the service handles None correctly.

**Do NOT modify prompts.py** — that happens in Plan 03.
  </action>
  <verify>
Run: `cd /Users/tyo/Omics-OS/lobster && python -c "
from lobster.agents.transcriptomics.shared_tools import create_shared_tools
from lobster.core.data_manager_v2 import DataManagerV2
from lobster.services.quality.preprocessing_service import PreprocessingService
from lobster.services.quality.quality_service import QualityService
dm = DataManagerV2.__new__(DataManagerV2)
dm._modalities = {}
tools = create_shared_tools(dm, QualityService(), PreprocessingService())
names = [t.name for t in tools]
print('filter_and_normalize' in names, 'select_variable_features' in names)
print('filter_and_normalize_modality' not in names, 'select_highly_variable_genes' not in names)
"`

Run: `cd /Users/tyo/Omics-OS/lobster && grep -n "filter_and_normalize_modality\|select_highly_variable_genes\|cluster_modality\|find_marker_genes_for_clusters" packages/lobster-transcriptomics/lobster/agents/transcriptomics/shared_tools.py packages/lobster-transcriptomics/lobster/agents/transcriptomics/transcriptomics_expert.py`
Expected: No matches (all old names should be gone from function definitions and log_tool_usage calls; may still appear in docstring references to old names for migration notes — that's OK)
  </verify>
  <done>
4 tools renamed (filter_and_normalize, select_variable_features, cluster_cells, find_marker_genes). BUG-01 fixed — subcluster_cells no longer crashes on None clusters_to_refine. Clustering tools list updated with new names.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 3 new SC tools (detect_doublets, integrate_batches, compute_trajectory)</name>
  <files>
    packages/lobster-transcriptomics/lobster/agents/transcriptomics/transcriptomics_expert.py
  </files>
  <action>
Add three new @tool functions to transcriptomics_expert.py in a new section between the existing clustering tools and the "COLLECT ALL TOOLS" section. Create a `# SC ANALYSIS TOOLS` section header.

**1. detect_doublets tool** (SCT-01):
- Signature: `def detect_doublets(modality_name: str, expected_doublet_rate: float = 0.025, threshold: Optional[float] = None) -> str`
- Docstring: "Detect doublets using Scrublet on raw counts. Run BEFORE filtering/normalization."
- Validate modality exists
- Call `enhanced_service.detect_doublets(adata, expected_doublet_rate=expected_doublet_rate, threshold=threshold)`
- Store result as `{modality_name}_doublets_detected`
- Log with `ir=ir`
- Response: number of doublets detected, doublet rate, recommendation to filter
- Follow the exact pattern of cluster_cells tool (validate → service call → store → log → response)

**2. integrate_batches tool** (SCT-02):
- Signature: `def integrate_batches(modality_name: str, batch_key: str, method: str = "harmony", n_pcs: int = 30) -> str`
- Docstring: "Integrate multi-sample batches using Harmony or Combat. Returns quality metrics (LISI, silhouette) for iterative refinement — re-invoke with different parameters if metrics are poor."
- Validate modality exists
- Call `enhanced_service.integrate_batches(adata, batch_key=batch_key, method=method, n_pcs=n_pcs)`
- Store result as `{modality_name}_integrated`
- Log with `ir=ir`
- Response MUST include: method used, n_batches, batch_silhouette score with interpretation (closer to 0 = better mixing), median_lisi with interpretation (closer to n_batches = better mixing), integrated_key for downstream use
- Add guidance: "If batch_silhouette > 0.3 or median_lisi < 1.5, consider re-running with different parameters"

**3. compute_trajectory tool** (SCT-03):
- Signature: `def compute_trajectory(modality_name: str, root_cell: Optional[int] = None, root_group: Optional[str] = None, cluster_key: str = "leiden", n_dcs: int = 15) -> str`
- Docstring: "Compute DPT pseudotime and PAGA trajectory. Requires clustered data with neighbors computed."
- Validate modality exists
- Call `enhanced_service.compute_trajectory(adata, root_cell=root_cell, root_group=root_group, cluster_key=cluster_key, n_dcs=n_dcs)`
- Store result as `{modality_name}_trajectory`
- Log with `ir=ir`
- Response: root cell index, pseudotime range, whether PAGA was computed, guidance on interpreting pseudotime

**Update the tool collection section:**
```python
# SC analysis tools
sc_analysis_tools = [
    detect_doublets,
    integrate_batches,
    compute_trajectory,
]

# Clustering tools
clustering_tools = [
    cluster_cells,
    subcluster_cells,
    evaluate_clustering_quality,
    find_marker_genes,
]

# Combine all direct tools
direct_tools = shared_tools + clustering_tools + sc_analysis_tools
```
  </action>
  <verify>
Run: `cd /Users/tyo/Omics-OS/lobster && python -c "
import inspect
from lobster.agents.transcriptomics import transcriptomics_expert as te
source = inspect.getsource(te)
for name in ['detect_doublets', 'integrate_batches', 'compute_trajectory']:
    print(f'{name}: {name in source}')
"`
Expected: All True

Run: `cd /Users/tyo/Omics-OS/lobster && python -c "
# Verify tool collection includes all tools
import ast, sys
with open('packages/lobster-transcriptomics/lobster/agents/transcriptomics/transcriptomics_expert.py') as f:
    content = f.read()
for tool_name in ['detect_doublets', 'integrate_batches', 'compute_trajectory', 'cluster_cells', 'find_marker_genes']:
    assert f'def {tool_name}(' in content, f'Missing: {tool_name}'
print('All SC tools present')
"`
  </verify>
  <done>
3 new SC tools added: detect_doublets (wraps existing service), integrate_batches (with LISI+silhouette quality metrics in response for LLM re-invocation), compute_trajectory (DPT+PAGA). All tools follow the validate→service→store→log→response pattern with ir=ir. Tool collection updated to include sc_analysis_tools list.
  </done>
</task>

</tasks>

<verification>
1. 4 tools renamed: filter_and_normalize, select_variable_features, cluster_cells, find_marker_genes
2. BUG-01 fixed: `subcluster_cells(clusters_to_refine=None)` no longer crashes
3. 3 new tools: detect_doublets, integrate_batches, compute_trajectory
4. All tools have `ir=ir` in log_tool_usage
5. No old tool names remain in function definitions or log_tool_usage calls
6. `grep -c "def detect_doublets\|def integrate_batches\|def compute_trajectory" transcriptomics_expert.py` returns 3
</verification>

<success_criteria>
- transcriptomics_expert.py has 7 clustering/SC tools (was 4): cluster_cells, subcluster_cells, evaluate_clustering_quality, find_marker_genes, detect_doublets, integrate_batches, compute_trajectory
- shared_tools.py has renamed tools: filter_and_normalize, select_variable_features
- BUG-01 is fixed with `n_refined = len(clusters_to_refine) if clusters_to_refine else "all"`
- integrate_batches response text includes batch_silhouette and median_lisi values with interpretation
</success_criteria>

<output>
After completion, create `.planning/phases/02-transcriptomics-parent/02-02-SUMMARY.md`
</output>
