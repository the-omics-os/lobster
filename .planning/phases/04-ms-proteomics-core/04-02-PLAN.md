---
phase: 04-ms-proteomics-core
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - packages/lobster-proteomics/lobster/agents/proteomics/proteomics_expert.py
  - packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py
  - packages/lobster-proteomics/lobster/agents/proteomics/config.py
autonomous: true
requirements:
  - MSP-01
  - MSP-03
  - MSP-06
  - MSP-07
  - MSP-08
  - MSP-09
  - MSP-10

must_haves:
  truths:
    - "import_proteomics_data tool wraps get_parser_for_file() and makes MS parsers LLM-accessible (BUG-07 fixed)"
    - "correct_batch_effects tool wraps existing ProteomicsPreprocessingService.correct_batch_effects for MS data"
    - "add_peptide_mapping is deprecated and merged into import_proteomics_data flow"
    - "validate_antibody_specificity uses pd.DataFrame.corr(min_periods=3) not np.nan_to_num (BUG-03 fixed)"
    - "detect_platform_type returns 'unknown' on tie/zero scores instead of silent mass_spec default (BUG-10 fixed)"
    - "filter_proteomics_data affinity branch has defensive checks for cv and antibody_quality columns (BUG-08 fixed)"
    - "cross_reactivity_threshold removed from affinity PlatformConfig (BUG-09 fixed)"
  artifacts:
    - path: "packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py"
      provides: "import_proteomics_data tool, import_ptm_sites tool, correct_batch_effects tool, summarize_peptide_to_protein tool, normalize_ptm_to_protein tool; filter_proteomics_data BUG-08 fix"
      contains: "def import_proteomics_data"
    - path: "packages/lobster-proteomics/lobster/agents/proteomics/proteomics_expert.py"
      provides: "Deprecated add_peptide_mapping, BUG-03 fix on validate_antibody_specificity"
      contains: "DEPRECATED"
    - path: "packages/lobster-proteomics/lobster/agents/proteomics/config.py"
      provides: "BUG-10 fix (unknown platform), BUG-09 fix (remove cross_reactivity_threshold)"
      contains: "return \"unknown\""
  key_links:
    - from: "shared_tools.py import_proteomics_data"
      to: "lobster.services.data_access.proteomics_parsers.get_parser_for_file"
      via: "Tool wraps parser auto-detection to make parsers LLM-accessible"
      pattern: "get_parser_for_file"
    - from: "shared_tools.py correct_batch_effects"
      to: "preprocessing_service.correct_batch_effects"
      via: "Tool wraps existing service method"
      pattern: "preprocessing_service.correct_batch_effects"
    - from: "shared_tools.py import_ptm_sites"
      to: "preprocessing_service.import_ptm_site_data"
      via: "Tool wraps new service method from Plan 01"
      pattern: "import_ptm_site_data"
    - from: "config.py detect_platform_type"
      to: "shared_tools.py _get_platform_for_modality"
      via: "Unknown platform type must be handled downstream"
      pattern: "unknown"
---

<objective>
Wire 5 new tools to the proteomics_expert parent agent (import_proteomics_data, import_ptm_sites, correct_batch_effects, summarize_peptide_to_protein, normalize_ptm_to_protein), deprecate add_peptide_mapping (MSP-06), and fix 4 bugs (BUG-03, BUG-08, BUG-09, BUG-10).

Purpose: Makes existing MS parsers LLM-accessible (BUG-07), adds PTM and batch correction tools, and fixes 4 data quality / logic bugs in config, shared_tools, and proteomics_expert.
Output: 5 new tools in shared_tools.py, 1 deprecated tool, 4 bug fixes across 3 files
</objective>

<execution_context>
@/Users/tyo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tyo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ms-proteomics-core/04-RESEARCH.md
@.planning/phases/04-ms-proteomics-core/04-01-SUMMARY.md
@packages/lobster-proteomics/lobster/agents/proteomics/proteomics_expert.py
@packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py
@packages/lobster-proteomics/lobster/agents/proteomics/config.py
@lobster/services/data_access/proteomics_parsers/__init__.py
@lobster/services/data_access/proteomics_parsers/base_parser.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix 4 bugs in config.py, shared_tools.py, and proteomics_expert.py</name>
  <files>packages/lobster-proteomics/lobster/agents/proteomics/config.py</files>
  <files>packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py</files>
  <files>packages/lobster-proteomics/lobster/agents/proteomics/proteomics_expert.py</files>
  <action>
Fix all 4 bugs before adding new tools (clean foundation first).

**BUG-10 fix (MSP-08) in config.py — detect_platform_type silent default:**

In `detect_platform_type()` (around line 233-237), change the return logic:

BEFORE:
```python
if detection_scores["affinity"] > detection_scores["mass_spec"]:
    return "affinity"
else:
    return "mass_spec"
```

AFTER:
```python
if detection_scores["affinity"] > detection_scores["mass_spec"]:
    return "affinity"
elif detection_scores["mass_spec"] > detection_scores["affinity"]:
    return "mass_spec"
else:
    return "unknown"
```

Also update the docstring Returns section to include "unknown" as a possible value.

**BUG-09 fix (MSP-10) in config.py — unused cross_reactivity_threshold:**

In the `PLATFORM_CONFIGS["affinity"]` dict (around line 124), remove `"cross_reactivity_threshold": 0.1` from the `platform_specific` dict. It is never referenced by any code. The `validate_antibody_specificity` tool uses its own `cross_reactivity_threshold` parameter.

**BUG-10 cascade fix in shared_tools.py — handle "unknown" platform:**

In `_get_platform_for_modality()` (around line 68-79), update to handle the new "unknown" return:

BEFORE:
```python
try:
    adata = data_manager.get_modality(modality_name)
    detected_type = detect_platform_type(adata)
    return get_platform_config(detected_type)
except ValueError:
    return get_platform_config("mass_spec")
```

AFTER:
```python
try:
    adata = data_manager.get_modality(modality_name)
    detected_type = detect_platform_type(adata)
    if detected_type == "unknown":
        logger.warning(f"Platform type ambiguous for '{modality_name}'. Defaulting to mass_spec. Use platform_type parameter to override.")
        return get_platform_config("mass_spec")
    return get_platform_config(detected_type)
except ValueError:
    return get_platform_config("mass_spec")
```

**BUG-08 fix (MSP-09) in shared_tools.py — filter_proteomics_data dead affinity branch:**

In `filter_proteomics_data()` (around lines 419-450), the affinity-specific filtering section checks for `adata.var["cv"]` and `adata.var["antibody_quality"]` which may not exist. Add defensive checks:

BEFORE:
```python
else:
    # Affinity: Filter by CV
    if "cv" in adata_filtered.var.columns:
        cv_filter = adata_filtered.var["cv"] <= platform_config.cv_threshold
        adata_filtered = adata_filtered[:, cv_filter].copy()

    # Affinity: Remove failed antibodies
    if "antibody_quality" in adata_filtered.var.columns:
        quality_filter = adata_filtered.var["antibody_quality"] != "failed"
        adata_filtered = adata_filtered[:, quality_filter].copy()
```

The code already has `if "cv" in` checks. The actual bug is that these columns are never produced by any upstream tool, so the branches are dead code. The fix is to keep the defensive checks (they are correct) but add a comment noting these columns come from external metadata, not from Lobster tools. This is NOT a code change but a documentation clarification. If the columns ARE present (user loaded data with these columns from Olink/SomaScan), the filtering works correctly. The bug is really "dead code that is defensively written" -- mark it with a comment:

```python
else:
    # Affinity: Filter by CV (column added by external Olink/SomaScan metadata, not by Lobster tools)
    if "cv" in adata_filtered.var.columns:
        ...
    # Affinity: Remove failed antibodies (column from assay QC metadata)
    if "antibody_quality" in adata_filtered.var.columns:
        ...
```

**BUG-03 fix (MSP-07) in proteomics_expert.py — validate_antibody_specificity inflated correlations:**

In `validate_antibody_specificity()` (around lines 290-305), replace the NaN-to-mean correlation with pairwise-complete correlation:

BEFORE:
```python
X_filled = np.nan_to_num(X, nan=np.nanmean(X))
cross_reactive_pairs = []

if adata_validated.n_vars > 1:
    correlation_matrix = np.corrcoef(X_filled.T)
```

AFTER:
```python
import pandas as pd

cross_reactive_pairs = []

if adata_validated.n_vars > 1:
    df = pd.DataFrame(X, columns=adata_validated.var_names)
    correlation_matrix = df.corr(method='pearson', min_periods=3).fillna(0).values
```

Remove the `X_filled = np.nan_to_num(...)` line entirely. This uses pairwise-complete observations for each pair, which avoids the inflated correlations caused by mean-filling.

Also deprecate `add_peptide_mapping` in proteomics_expert.py (MSP-06):

Replace the body of `add_peptide_mapping` tool (lines ~146-261) with a deprecation message. Keep the decorator and signature intact. Replace the body with:
```python
logger.warning("add_peptide_mapping is deprecated. Use import_proteomics_data which automatically extracts peptide mapping from parser output.")
return "DEPRECATED: add_peptide_mapping has been merged into import_proteomics_data. " \
       "MaxQuant/DIA-NN/Spectronaut parsers automatically extract peptide counts, " \
       "unique peptides, and sequence coverage during import."
```

Remove `add_peptide_mapping` from the `platform_tools` list (around line 500-504). The deprecated function stays in the file but is not included in the tool collection.
  </action>
  <verify>
1. `grep "return.*unknown" packages/lobster-proteomics/lobster/agents/proteomics/config.py` -- should find "unknown" return
2. `grep "cross_reactivity_threshold" packages/lobster-proteomics/lobster/agents/proteomics/config.py` -- should return ZERO matches (removed)
3. `grep "df.corr" packages/lobster-proteomics/lobster/agents/proteomics/proteomics_expert.py` -- should find pairwise correlation fix
4. `grep "nan_to_num" packages/lobster-proteomics/lobster/agents/proteomics/proteomics_expert.py` -- should return ZERO matches (removed)
5. `grep "DEPRECATED" packages/lobster-proteomics/lobster/agents/proteomics/proteomics_expert.py` -- should find add_peptide_mapping deprecation
6. `grep "add_peptide_mapping" packages/lobster-proteomics/lobster/agents/proteomics/proteomics_expert.py | grep "platform_tools"` -- should NOT contain add_peptide_mapping in the list
7. `grep 'unknown.*Defaulting' packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py` -- should find cascade fix
  </verify>
  <done>4 bugs fixed: BUG-10 returns "unknown" on tie, BUG-09 removes cross_reactivity_threshold, BUG-08 adds clarifying comments on defensive checks, BUG-03 uses pairwise-complete correlation; add_peptide_mapping deprecated and removed from platform_tools</done>
</task>

<task type="auto">
  <name>Task 2: Add 5 new tools to shared_tools.py and update proteomics_expert.py tool collection</name>
  <files>packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py</files>
  <files>packages/lobster-proteomics/lobster/agents/proteomics/proteomics_expert.py</files>
  <action>
Add 5 new tools inside the `create_shared_tools` factory function in shared_tools.py, and update the return list. Then update proteomics_expert.py to reflect the expanded tool set.

**Add required imports** at the top of shared_tools.py (inside or outside the factory as appropriate):
```python
from pathlib import Path
```

**1. `import_proteomics_data` tool (MSP-01 — BUG-07 fix):**

Add inside `create_shared_tools()`:

```python
@tool
def import_proteomics_data(
    file_path: str,
    software: str = "auto",
    intensity_type: str = "auto",
    filter_contaminants: bool = True,
    filter_reverse: bool = True,
    modality_name: str = "",
    save_result: bool = True,
) -> str:
    """Import MS proteomics data from search engine output files (MaxQuant, DIA-NN, Spectronaut).

    Auto-detects the file format and uses the appropriate parser. Peptide mapping
    (counts, unique peptides, sequence coverage) is extracted automatically during import.

    Args:
        file_path: Path to the proteomics output file (e.g., proteinGroups.txt, report.tsv)
        software: Parser to use ("auto", "maxquant", "diann", "spectronaut")
        intensity_type: Intensity column type ("auto", "lfq", "intensity", "maxlfq")
        filter_contaminants: Remove known contaminant proteins (default True)
        filter_reverse: Remove reverse database hits (default True)
        modality_name: Name for the imported modality (auto-generated if empty)
        save_result: Whether to save the modality to disk

    Returns:
        str: Import summary with sample count, protein count, and data characteristics
    """
```

Implementation:
- Lazy import: `from lobster.services.data_access.proteomics_parsers import get_parser_for_file, MaxQuantParser, DIANNParser, SpectronautParser`
- If software == "auto": use `get_parser_for_file(file_path)`. If None, return error message listing supported formats.
- If software specified: map to parser class and instantiate. Use dict: `{"maxquant": MaxQuantParser, "diann": DIANNParser, "spectronaut": SpectronautParser}`. Check if class is None (package not installed).
- Call `parser.parse(file_path, ...)` with appropriate kwargs. Pass `intensity_type`, `filter_contaminants`, `filter_reverse` to parsers that accept them (check with hasattr or try/except).
- Handle both 2-tuple and 3-tuple returns: `if len(result) == 3: adata, stats, ir = result` else create IR manually using AnalysisStep.
- Generate modality name if not provided: `f"ms_{parser.name.lower()}_{Path(file_path).stem}"`
- Store modality via `data_manager.store_modality(name=name, adata=adata, step_summary=f"Imported {parser.name} data: {adata.n_obs} samples x {adata.n_vars} proteins")`
- Save if requested
- Log tool usage with ir=ir
- Return detailed summary: parser used, samples, proteins, missing %, intensity type, peptide mapping info (if in var columns: n_peptides, unique_peptides, sequence_coverage stats)

**2. `import_ptm_sites` tool (MSP-02):**

```python
@tool
def import_ptm_sites(
    file_path: str,
    ptm_type: str = "phospho",
    localization_threshold: float = 0.75,
    filter_contaminants: bool = True,
    modality_name: str = "",
    save_result: bool = True,
) -> str:
    """Import PTM site-level quantification data (phospho/acetyl/ubiquitin).

    Reads MaxQuant-style site-level output and creates a site-level AnnData.
    Sites are identified as gene_residuePosition (e.g., EGFR_Y1068).
    Only class I sites (localization probability >= threshold) are kept.

    Args:
        file_path: Path to PTM site file (e.g., Phospho(STY)Sites.txt)
        ptm_type: Type of PTM ("phospho", "acetyl", "ubiquitin")
        localization_threshold: Minimum localization probability (default 0.75)
        filter_contaminants: Remove contaminant proteins
        modality_name: Name for modality (auto-generated if empty)
        save_result: Whether to save to disk

    Returns:
        str: Import summary with site count, sample count, PTM type details
    """
```

Implementation: wraps `preprocessing_service.import_ptm_site_data()` from Plan 01. Store modality, log with IR.

**3. `correct_batch_effects` tool (MSP-03):**

```python
@tool
def correct_batch_effects(
    modality_name: str,
    batch_column: str = "batch",
    method: str = "combat",
    reference_batch: str = "",
    save_result: bool = True,
) -> str:
    """Correct batch effects in MS proteomics data using ComBat or median centering.

    For multi-batch MS experiments (different runs, instruments, or processing dates).
    This is distinct from correct_plate_effects which is specific to affinity platforms.

    Args:
        modality_name: Name of the proteomics modality
        batch_column: Column in obs containing batch identifiers
        method: Correction method ("combat", "median_centering", "reference_based")
        reference_batch: Reference batch for reference_based method (empty for auto)
        save_result: Whether to save corrected modality

    Returns:
        str: Batch correction report with before/after metrics
    """
```

Implementation: wraps existing `preprocessing_service.correct_batch_effects(adata, batch_key=batch_column, method=method, reference_batch=reference_batch or None)`. Store modality with suffix `_batch_corrected`, log with IR from service.

**4. `summarize_peptide_to_protein` tool (MSP-04):**

```python
@tool
def summarize_peptide_to_protein(
    modality_name: str,
    method: str = "median",
    protein_column: str = "protein_id",
    save_result: bool = True,
) -> str:
    """Roll up peptide/PSM-level quantification to protein-level.

    Required for TMT workflows where reporter ion intensities are at peptide/PSM level.
    Aggregates peptides to proteins using median (robust) or sum methods.

    Args:
        modality_name: Name of the peptide-level modality
        method: Aggregation method ("median", "sum")
        protein_column: Column in var mapping peptides to proteins
        save_result: Whether to save protein-level modality

    Returns:
        str: Summarization report with peptide-to-protein statistics
    """
```

Implementation: wraps `preprocessing_service.summarize_peptide_to_protein()` from Plan 01. Store as new modality with suffix `_protein_rollup`, log with IR.

**5. `normalize_ptm_to_protein` tool (MSP-05):**

```python
@tool
def normalize_ptm_to_protein(
    ptm_modality_name: str,
    protein_modality_name: str,
    method: str = "ratio",
    save_result: bool = True,
) -> str:
    """Normalize PTM site abundances against total protein levels.

    Separates true PTM regulation from protein abundance changes.
    Essential for phosphoproteomics where increased phosphorylation
    may just reflect increased total protein.

    Args:
        ptm_modality_name: Name of the PTM site-level modality
        protein_modality_name: Name of the protein-level modality
        method: "ratio" (log subtraction) or "regression" (residuals)
        save_result: Whether to save normalized modality

    Returns:
        str: Normalization report with matching statistics
    """
```

Implementation: wraps `preprocessing_service.normalize_ptm_to_protein()` from Plan 01. Store as new modality with suffix `_ptm_normalized`, log with IR.

**Update the return list** in `create_shared_tools()` to include the 5 new tools:

```python
return [
    # Status & QC
    check_proteomics_status,
    assess_proteomics_quality,
    # Import
    import_proteomics_data,
    import_ptm_sites,
    # Filtering & preprocessing
    filter_proteomics_data,
    normalize_proteomics_data,
    correct_batch_effects,
    # Rollup & PTM normalization
    summarize_peptide_to_protein,
    normalize_ptm_to_protein,
    # Analysis
    analyze_proteomics_patterns,
    impute_missing_values,
    select_variable_proteins,
    # Summary
    create_proteomics_summary,
]
```

**Update proteomics_expert.py**: No changes needed to the tool collection logic since shared_tools are consumed via `create_shared_tools()`. The `platform_tools` list should now only contain `validate_antibody_specificity` and `correct_plate_effects` (add_peptide_mapping removed in Task 1).
  </action>
  <verify>
1. `grep -c "def import_proteomics_data\|def import_ptm_sites\|def correct_batch_effects\b\|def summarize_peptide_to_protein\|def normalize_ptm_to_protein" packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py` -- should be 5
2. `grep "get_parser_for_file" packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py` -- should find import in import_proteomics_data
3. `grep "import_ptm_site_data" packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py` -- should find service call in import_ptm_sites
4. `grep "log_tool_usage" packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py | wc -l` -- should be 13 (8 existing + 5 new)
5. `grep "import_proteomics_data\|import_ptm_sites\|correct_batch_effects\|summarize_peptide_to_protein\|normalize_ptm_to_protein" packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py | grep "return \["` -- verify all 5 in return list
6. `grep "platform_tools" packages/lobster-proteomics/lobster/agents/proteomics/proteomics_expert.py` -- should show only validate_antibody_specificity and correct_plate_effects
  </verify>
  <done>5 new tools added to shared_tools.py: import_proteomics_data wraps parsers (BUG-07 fixed), import_ptm_sites wraps PTM service, correct_batch_effects wraps existing service, summarize_peptide_to_protein wraps rollup service, normalize_ptm_to_protein wraps PTM normalization service; all have IR and are in return list</done>
</task>

</tasks>

<verification>
1. All 7 requirements addressed: MSP-01 (import_proteomics_data), MSP-03 (correct_batch_effects), MSP-06 (add_peptide_mapping deprecated), MSP-07 (BUG-03 pairwise correlation), MSP-08 (BUG-10 unknown platform), MSP-09 (BUG-08 affinity branch), MSP-10 (BUG-09 cross_reactivity_threshold)
2. Tool count after Phase 4: 13 shared + 2 platform-specific = 15 (at limit, acceptable)
3. All new tools follow 3-tuple pattern with AnalysisStep IR
4. All 4 bugs fixed with no regressions
5. detect_platform_type "unknown" cascade handled in _get_platform_for_modality
6. add_peptide_mapping deprecated (body replaced) and removed from platform_tools list
</verification>

<success_criteria>
- import_proteomics_data auto-detects and parses MaxQuant/DIA-NN/Spectronaut files
- import_ptm_sites imports phospho/acetyl/ubiquitin site data with localization filtering
- correct_batch_effects wraps ComBat/median centering for MS batch correction
- summarize_peptide_to_protein rolls up peptide data to protein level
- normalize_ptm_to_protein separates PTM regulation from protein abundance
- validate_antibody_specificity uses pairwise-complete correlation (no mean-fill inflation)
- detect_platform_type returns "unknown" on ambiguous data
- filter_proteomics_data affinity branch has clarifying comments
- cross_reactivity_threshold removed from config
- add_peptide_mapping returns deprecation message and is not in tool list
</success_criteria>

<output>
After completion, create `.planning/phases/04-ms-proteomics-core/04-02-SUMMARY.md`
</output>
