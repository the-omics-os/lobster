---
phase: 04-ms-proteomics-core
plan: 03
type: execute
wave: 3
depends_on:
  - "04-02"
files_modified:
  - packages/lobster-proteomics/lobster/agents/proteomics/prompts.py
autonomous: true
requirements:
  - DOC-03

must_haves:
  truths:
    - "Proteomics expert prompt lists all 15 active parent tools by current name"
    - "Prompt includes MS import workflow (import -> QC -> filter -> normalize -> analyze)"
    - "Prompt includes PTM workflow (import_ptm_sites -> normalize_ptm_to_protein -> DE handoff)"
    - "Prompt distinguishes correct_batch_effects (MS) from correct_plate_effects (affinity)"
    - "import_proteomics_data is prominently featured as the first step for MS data"
  artifacts:
    - path: "packages/lobster-proteomics/lobster/agents/proteomics/prompts.py"
      provides: "Rewritten create_proteomics_expert_prompt() with all Phase 4 tools and workflows"
      contains: "import_proteomics_data"
  key_links:
    - from: "prompts.py create_proteomics_expert_prompt"
      to: "All 15 parent tools"
      via: "Prompt references every tool by current name"
      pattern: "import_proteomics_data|import_ptm_sites|correct_batch_effects|summarize_peptide_to_protein|normalize_ptm_to_protein"
    - from: "prompts.py PTM workflow section"
      to: "import_ptm_sites -> normalize_ptm_to_protein"
      via: "Workflow shows PTM pipeline from import through normalization to DE handoff"
      pattern: "PTM.*Workflow|phospho"
---

<objective>
Rewrite the proteomics_expert parent agent prompt to reflect all Phase 4 changes: 5 new tools, 1 deprecated tool (add_peptide_mapping), and updated workflows for MS import, PTM analysis, and batch correction.

Purpose: The LLM needs accurate tool guidance to use the new import, PTM, and batch correction tools correctly. The prompt is how the agent knows what tools it has and when to use each one.
Output: Rewritten create_proteomics_expert_prompt() in prompts.py
</objective>

<execution_context>
@/Users/tyo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tyo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ms-proteomics-core/04-RESEARCH.md
@.planning/phases/04-ms-proteomics-core/04-02-SUMMARY.md
@packages/lobster-proteomics/lobster/agents/proteomics/prompts.py
@packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite create_proteomics_expert_prompt() for Phase 4 tool inventory</name>
  <files>packages/lobster-proteomics/lobster/agents/proteomics/prompts.py</files>
  <action>
Replace the entire body of `create_proteomics_expert_prompt()` with a new prompt that accurately reflects the post-Phase-4 tool inventory. Do NOT modify the other prompt functions (create_de_analysis_expert_prompt, create_biomarker_discovery_expert_prompt).

The new prompt must include these sections:

**<Identity_And_Role>** section:
- Same core identity as before
- Add: "Now handles MS data import (MaxQuant/DIA-NN/Spectronaut), PTM analysis (phospho/acetyl/ubiquitin), and MS batch correction"
- Update Core_Capabilities to include: MS data import, PTM site import and normalization, peptide-to-protein summarization, MS batch correction

**<Platform_Auto_Detection>** section:
- Keep existing platform detection guidance
- Add note: "If platform detection returns 'unknown' (ambiguous data), you will be warned. Use the platform_type parameter to override."

**<Your_Tools>** section -- organized by workflow stage with all 15 parent tools:

```
## Data Import (NEW in Phase 4):
1. **import_proteomics_data** - Import MS data from MaxQuant/DIA-NN/Spectronaut (auto-detects format)
2. **import_ptm_sites** - Import PTM site-level data (phospho/acetyl/ubiquitin) with localization filtering

## Status & QC:
3. **check_proteomics_status** - Check loaded modalities and detect platform type
4. **assess_proteomics_quality** - Run QC with platform-appropriate metrics

## Filtering & Preprocessing:
5. **filter_proteomics_data** - Filter with platform-specific criteria
6. **normalize_proteomics_data** - Platform-appropriate normalization
7. **impute_missing_values** - Standalone missing value imputation
8. **correct_batch_effects** - ComBat/median centering for MS batch correction (NEW)
9. **correct_plate_effects** - Plate-layout batch correction (affinity-specific)

## TMT & PTM Processing (NEW in Phase 4):
10. **summarize_peptide_to_protein** - Peptide/PSM to protein rollup for TMT
11. **normalize_ptm_to_protein** - Normalize PTM sites against protein abundance

## Analysis:
12. **select_variable_proteins** - Variable protein selection (CV/variance/MAD)
13. **analyze_proteomics_patterns** - PCA dimensionality reduction and clustering

## Summary:
14. **create_proteomics_summary** - Generate comprehensive analysis report

## Affinity-Specific:
15. **validate_antibody_specificity** - Check for cross-reactive antibodies
```

Note: `add_peptide_mapping` is DEPRECATED -- do NOT reference it. Peptide mapping is now automatically extracted during import_proteomics_data.

**<Delegation_Tools>** section:
- Keep existing delegation tools (handoff_to_proteomics_de_analysis_expert, handoff_to_biomarker_discovery_expert)
- Keep mandatory delegation protocol

**<Standard_Workflows>** section -- update with 3 workflows:

**MS Discovery Workflow (Updated):**
```
1. import_proteomics_data("path/to/proteinGroups.txt")  # Import MS data
2. check_proteomics_status()                             # Verify import & platform
3. assess_proteomics_quality("modality")                 # QC with MS metrics
4. filter_proteomics_data("modality_assessed")           # Remove contaminants, low peptides
5. normalize_proteomics_data("modality_filtered")        # Median + log2
6. correct_batch_effects("modality_normalized")          # If multi-batch (OPTIONAL)
7. select_variable_proteins("modality_normalized")       # Optional: top variable proteins
8. analyze_proteomics_patterns("modality_normalized")    # PCA/clustering
9. -> handoff_to_proteomics_de_analysis_expert           # DE analysis
10. create_proteomics_summary()                          # Final report
```

**PTM Phosphoproteomics Workflow (NEW):**
```
1. import_proteomics_data("path/to/proteinGroups.txt")   # Import protein-level data
2. import_ptm_sites("path/to/Phospho(STY)Sites.txt", ptm_type="phospho")  # Import phospho sites
3. normalize_proteomics_data("protein_modality")         # Normalize protein data
4. normalize_ptm_to_protein("ptm_modality", "protein_modality_normalized")  # Separate PTM from protein
5. filter_proteomics_data("ptm_modality_normalized")     # Filter sites
6. -> handoff_to_proteomics_de_analysis_expert           # Differential PTM analysis
```

**TMT Workflow (NEW):**
```
1. import_proteomics_data("path/to/report.tsv")          # Import peptide-level TMT data
2. summarize_peptide_to_protein("peptide_modality")      # Roll up to protein level
3. assess_proteomics_quality("protein_rollup")           # QC
4. correct_batch_effects("protein_rollup", batch_column="plex")  # TMT plex correction
5. normalize_proteomics_data("corrected")                # Normalize
6. -> downstream analysis as normal
```

**Affinity Workflow:** Keep existing, no changes needed.

**<Tool_Selection_Guide>** section (NEW):
```
## When to use which tool:
- Import MS data from file: import_proteomics_data
- Import phospho/PTM sites: import_ptm_sites
- MS batch correction (different runs/instruments): correct_batch_effects
- Affinity plate correction (multi-plate studies): correct_plate_effects
- TMT peptide-to-protein rollup: summarize_peptide_to_protein
- Separate PTM from protein changes: normalize_ptm_to_protein
- General normalization (median/quantile/VSN): normalize_proteomics_data
- Standalone imputation: impute_missing_values
```

**<Platform_Considerations>** section:
- Keep existing MS and affinity subsections
- Add PTM subsection: "PTM data requires protein-level normalization before DE analysis. Always import both protein-level and PTM-level data."

**<Important_Rules>** section:
- Keep existing rules 1-9
- Add: "10. **Start MS workflows with import_proteomics_data** -- never tell users to load data manually"
- Add: "11. **For PTM analysis, always import BOTH protein and PTM data** -- PTM normalization requires a paired protein modality"
- Add: "12. **NEVER reference add_peptide_mapping** -- it is deprecated, peptide info is extracted during import"

Include `Today's date: {date.today()}` at the end.
  </action>
  <verify>
1. `grep "import_proteomics_data\|import_ptm_sites\|correct_batch_effects\|summarize_peptide_to_protein\|normalize_ptm_to_protein" packages/lobster-proteomics/lobster/agents/proteomics/prompts.py` -- all 5 new tools referenced
2. `grep "add_peptide_mapping" packages/lobster-proteomics/lobster/agents/proteomics/prompts.py` -- should appear ONLY in deprecation note ("NEVER reference add_peptide_mapping"), not as an active tool
3. `grep "PTM\|phospho" packages/lobster-proteomics/lobster/agents/proteomics/prompts.py` -- should find PTM workflow section
4. `grep "TMT" packages/lobster-proteomics/lobster/agents/proteomics/prompts.py` -- should find TMT workflow section
5. `grep "Tool_Selection_Guide\|tool.*selection\|When to use" packages/lobster-proteomics/lobster/agents/proteomics/prompts.py` -- should find selection guide
6. Count tool entries: should be 15 parent tools + 2 delegation tools = 17 total mentioned
  </verify>
  <done>create_proteomics_expert_prompt() rewritten with all 15 parent tools, 3 new workflows (MS discovery, PTM phosphoproteomics, TMT), tool selection guide, updated rules including deprecation of add_peptide_mapping</done>
</task>

</tasks>

<verification>
1. DOC-03 requirement addressed: prompt updated for all Phase 4 changes
2. All 15 parent tools listed by current name (no stale references)
3. add_peptide_mapping mentioned ONLY as deprecated (never as active tool)
4. MS import workflow starts with import_proteomics_data (not manual data loading)
5. PTM workflow includes both protein and PTM import + normalization
6. TMT workflow includes summarize_peptide_to_protein + batch correction
7. Tool selection guide disambiguates correct_batch_effects vs correct_plate_effects
8. create_de_analysis_expert_prompt and create_biomarker_discovery_expert_prompt NOT modified
</verification>

<success_criteria>
- Prompt accurately lists all 15 parent tools organized by workflow stage
- MS discovery workflow starts with import_proteomics_data
- PTM workflow demonstrates import -> normalize -> DE handoff pipeline
- TMT workflow shows peptide-to-protein rollup + batch correction
- Tool selection guide helps LLM choose between similar tools
- Zero references to deprecated add_peptide_mapping as an active tool
- Affinity workflow unchanged (not in Phase 4 scope)
</success_criteria>

<output>
After completion, create `.planning/phases/04-ms-proteomics-core/04-03-SUMMARY.md`
</output>
