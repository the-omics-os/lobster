---
phase: 04-performance
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - tests/unit/core/vector/test_embedders.py
  - tests/unit/core/vector/test_rerankers.py
  - tests/unit/core/vector/test_vector_search_service.py
  - tests/unit/core/vector/test_config.py
autonomous: true
requirements:
  - TEST-02
  - TEST-03

must_haves:
  truths:
    - "SapBERT embedder tests verify CLS pooling config and lazy loading without requiring torch"
    - "CrossEncoderReranker tests verify lazy model loading, score ordering, and edge cases with mocked model"
    - "CohereReranker tests verify graceful degradation when API key missing and normal operation when present"
    - "Service reranking tests verify match_ontology() uses reranker when injected and preserves order"
    - "Config tests verify LOBSTER_RERANKER env var reading and create_reranker() factory"
  artifacts:
    - path: "tests/unit/core/vector/test_embedders.py"
      provides: "Mocked unit tests for embedding providers (SapBERT focus)"
      contains: "class TestSapBERTEmbedder"
    - path: "tests/unit/core/vector/test_rerankers.py"
      provides: "Mocked unit tests for CrossEncoderReranker and CohereReranker"
      contains: "class TestCrossEncoderReranker"
    - path: "tests/unit/core/vector/test_vector_search_service.py"
      provides: "Reranking integration tests added to existing service test file"
      contains: "class TestMatchOntologyReranking"
    - path: "tests/unit/core/vector/test_config.py"
      provides: "Reranker config tests added to existing config test file"
      contains: "class TestRerankerConfig"
  key_links:
    - from: "tests/unit/core/vector/test_rerankers.py"
      to: "lobster/core/vector/rerankers/base.py"
      via: "MockReranker extends BaseReranker for service tests"
      pattern: "class MockReranker.*BaseReranker"
    - from: "tests/unit/core/vector/test_vector_search_service.py"
      to: "lobster/core/vector/service.py"
      via: "Service constructed with MockReranker to test reranking path"
      pattern: "VectorSearchService.*reranker="
---

<objective>
Comprehensive unit tests for embedding providers and rerankers, plus reranking integration tests for VectorSearchService and config.

Purpose: Validates the reranker infrastructure built in Plan 01 with mocked heavy dependencies (no torch, no Cohere API needed). Ensures lazy loading, graceful degradation, score normalization, and service integration work correctly.

Output: Two new test files (test_embedders.py, test_rerankers.py) and additions to two existing test files (test_vector_search_service.py, test_config.py).
</objective>

<execution_context>
@/Users/tyo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tyo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-performance/04-RESEARCH.md
@.planning/phases/04-performance/04-01-SUMMARY.md

@lobster/core/vector/rerankers/base.py
@lobster/core/vector/rerankers/cross_encoder_reranker.py
@lobster/core/vector/rerankers/cohere_reranker.py
@lobster/core/vector/config.py
@lobster/core/vector/service.py
@lobster/core/vector/embeddings/sapbert.py
@lobster/core/schemas/search.py
@tests/unit/core/vector/test_vector_search_service.py
@tests/unit/core/vector/test_config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: test_embedders.py and test_rerankers.py with mocked dependencies</name>
  <files>
    tests/unit/core/vector/test_embedders.py
    tests/unit/core/vector/test_rerankers.py
  </files>
  <action>
**test_embedders.py** (TEST-02) -- Unit tests for SapBERT embedder with mocked sentence-transformers:

Tests to include (all mock `sentence_transformers` to avoid torch dependency):

1. `TestSapBERTEmbedderLazyLoading`:
   - `test_model_not_loaded_on_init`: Create SapBERTEmbedder, verify `_model is None`
   - `test_model_loaded_on_first_embed_text`: Mock `sentence_transformers.SentenceTransformer` and `sentence_transformers.models.Transformer`/`Pooling`, call `embed_text("test")`, verify model constructor was called
   - `test_model_loaded_once_across_calls`: Call `embed_text` twice, verify model constructor called only once

2. `TestSapBERTEmbedderConfig`:
   - `test_cls_pooling_configured`: Mock imports, call embed_text, verify `Pooling` was created with `pooling_mode="cls"` (not "mean")
   - `test_model_name_is_sapbert`: Verify `SapBERTEmbedder.MODEL_NAME == "cambridgeltl/SapBERT-from-PubMedBERT-fulltext"`
   - `test_dimensions_is_768`: Verify `embedder.dimensions == 768`
   - `test_batch_size_128`: Mock model, call `embed_batch(["a", "b"])`, verify `encode` called with `batch_size=128`

3. `TestSapBERTEmbedderImportGuard`:
   - `test_import_error_has_helpful_message`: Patch `builtins.__import__` to raise ImportError for sentence_transformers, call `embed_text`, verify ImportError message contains "pip install" and "vector-search"

4. `TestBaseEmbedderContract`:
   - `test_abc_cannot_be_instantiated`: Verify `BaseEmbedder()` raises TypeError
   - `test_mock_embedder_satisfies_contract`: Verify MockEmbedder (from test_vector_search_service.py) is a valid BaseEmbedder subclass

Mocking strategy: Use `unittest.mock.patch` on `sentence_transformers.SentenceTransformer`, `sentence_transformers.models.Transformer`, and `sentence_transformers.models.Pooling`. The mocked SentenceTransformer.encode should return a numpy array of the right shape.

**test_rerankers.py** (TEST-03) -- Unit tests for CrossEncoderReranker and CohereReranker with mocked clients:

1. `TestBaseRerankerContract`:
   - `test_abc_cannot_be_instantiated`: Verify `BaseReranker()` raises TypeError
   - `test_normalize_scores_basic`: Test normalize_scores with [8.6, 3.4, -1.2] -> [1.0, ~0.47, 0.0]
   - `test_normalize_scores_equal_values`: All same score -> all 1.0
   - `test_normalize_scores_empty_list`: Empty input -> empty output
   - `test_normalize_scores_single_item`: Single item -> score 1.0

2. `TestCrossEncoderReranker`:
   - `test_model_not_loaded_on_init`: Create instance, verify `_model is None`
   - `test_lazy_loading_on_first_rerank`: Mock `sentence_transformers.CrossEncoder`, call `rerank()`, verify CrossEncoder constructor called with model name
   - `test_model_loaded_once`: Call `rerank()` twice, verify constructor called once
   - `test_rerank_returns_sorted_results`: Mock model.rank() to return known results, verify output format matches contract (corpus_id, score, text keys)
   - `test_rerank_top_k_passed_to_model`: Call rerank with top_k=3, verify model.rank() received top_k=3
   - `test_rerank_empty_documents`: Empty list -> empty list returned (no model loaded)
   - `test_rerank_single_document`: Single doc -> returned as-is with score=1.0 (no model loaded)
   - `test_import_error_has_helpful_message`: Patch builtins.__import__, verify ImportError message

3. `TestCohereReranker`:
   - `test_no_api_key_logs_warning_returns_original_order`: Clear COHERE_API_KEY and CO_API_KEY env vars, call rerank(), verify warning logged, results in original order
   - `test_no_api_key_returns_synthetic_scores`: Verify degraded path returns descending synthetic scores
   - `test_api_key_present_calls_client`: Set COHERE_API_KEY env var, mock `cohere.ClientV2`, call rerank(), verify client.rerank() was called
   - `test_cohere_response_format`: Mock client.rerank() to return mock response with .results list of objects with .index and .relevance_score, verify output format
   - `test_cohere_top_k_passed_as_top_n`: Verify top_k is forwarded to client.rerank() as top_n param
   - `test_cohere_model_name_default`: Verify default model is "rerank-v4.0-pro"
   - `test_cohere_model_env_override`: Set COHERE_RERANK_MODEL env var, verify it's used
   - `test_cohere_import_error_degrades`: Patch builtins.__import__ to fail for cohere, verify warning and graceful degradation
   - `test_available_checked_once`: Call rerank() twice, verify _init_client() logic runs once (check _available flag)
   - `test_empty_documents`: Empty list -> empty list returned
   - `test_single_document`: Single doc -> returned as-is with score=1.0

4. `TestMockReranker`:
   - Create a MockReranker class (extends BaseReranker) in this test file for use by service tests. It reverses document order to simulate reranking and produces known scores. Expose `_last_query` and `_last_documents` for assertions.
   - `test_mock_reranker_reverses_order`: Verify basic behavior
   - `test_mock_reranker_respects_top_k`: Verify truncation

Mocking strategy for Cohere: Create mock objects for `cohere.ClientV2` and its response. The response mock needs `.results` attribute that is a list of objects with `.index` (int) and `.relevance_score` (float) attributes.
  </action>
  <verify>
```bash
cd /Users/tyo/Omics-OS/lobster
pytest tests/unit/core/vector/test_embedders.py -v
pytest tests/unit/core/vector/test_rerankers.py -v
```
All tests pass without requiring torch, sentence-transformers, or cohere installed (everything mocked).
  </verify>
  <done>
test_embedders.py has tests for SapBERT lazy loading, CLS pooling config, dimensions, batch_size, and import guard. test_rerankers.py has tests for normalize_scores, CrossEncoderReranker (lazy loading, sort order, edge cases), CohereReranker (graceful degradation, API call, env var override, edge cases), and MockReranker helper.
  </done>
</task>

<task type="auto">
  <name>Task 2: Reranking integration tests in existing test files</name>
  <files>
    tests/unit/core/vector/test_vector_search_service.py
    tests/unit/core/vector/test_config.py
  </files>
  <action>
**test_vector_search_service.py** -- Add a new test class `TestMatchOntologyReranking` at the end of the file:

Import the MockReranker from test_rerankers.py: `from tests.unit.core.vector.test_rerankers import MockReranker` (or define a local MockReranker if import causes issues -- use the same pattern).

Tests:
1. `test_match_ontology_with_reranker_changes_order`: Create VectorSearchService with `reranker=MockReranker(reverse=True)`, set mock_backend results with known order, call `match_ontology()`, verify results are in reversed order (reranker reorders)
2. `test_match_ontology_without_reranker_preserves_order`: Create service with no reranker (default), verify match_ontology returns results in backend order (no reranking)
3. `test_match_ontology_reranker_scores_normalized`: With MockReranker, verify all returned OntologyMatch scores are in [0.0, 1.0] range
4. `test_match_ontology_reranker_truncates_to_k`: With reranker, verify k parameter is respected (reranker sees oversampled set, returns are truncated to k)
5. `test_match_ontology_single_result_skips_reranker`: Set backend to return 1 result, add reranker, verify reranker.rerank() was NOT called (check _last_query is None)
6. `test_match_ontology_reranker_receives_oversampled_candidates`: With k=3, verify the reranker sees 3*4=12 candidates (check MockReranker._last_documents length or mock_backend._last_search_n_results)

Fixture: Add a `service_with_reranker` fixture that creates VectorSearchService with mock_backend + mock_embedder + MockReranker.

**test_config.py** -- Add a new test class `TestRerankerConfig` at the end of the file:

Tests:
1. `test_default_reranker_is_none`: VectorSearchConfig() has reranker == RerankerType.none
2. `test_from_env_reads_lobster_reranker`: Set LOBSTER_RERANKER=cross_encoder env var, verify config.reranker == RerankerType.cross_encoder
3. `test_from_env_default_reranker_none`: No env var -> RerankerType.none
4. `test_from_env_invalid_reranker_falls_back_to_none`: Set LOBSTER_RERANKER=invalid, verify it falls back to RerankerType.none (not crash)
5. `test_create_reranker_none_returns_none`: config with reranker=none -> create_reranker() returns None
6. `test_create_reranker_cross_encoder`: config with reranker=cross_encoder -> create_reranker() returns CrossEncoderReranker instance (will need try/except for import of sentence_transformers -- skip if not available)
7. `test_create_reranker_cohere`: config with reranker=cohere -> create_reranker() returns CohereReranker instance (always works since CohereReranker only imports cohere lazily on rerank())

Run full test suite to confirm everything passes together.
  </action>
  <verify>
```bash
cd /Users/tyo/Omics-OS/lobster
pytest tests/unit/core/vector/ -v
```
All tests pass (both new and existing). Zero regressions.
  </verify>
  <done>
TestMatchOntologyReranking class added to test_vector_search_service.py with 6 tests covering reranker integration in match_ontology(). TestRerankerConfig class added to test_config.py with 7 tests covering LOBSTER_RERANKER env var reading and create_reranker() factory. All existing tests continue to pass.
  </done>
</task>

</tasks>

<verification>
1. Full test suite passes: `pytest tests/unit/core/vector/ -v`
2. test_embedders.py: All SapBERT tests pass with mocked sentence-transformers
3. test_rerankers.py: All CrossEncoder + Cohere + normalize_scores tests pass with mocks
4. test_vector_search_service.py: New reranking tests + all existing tests pass
5. test_config.py: New reranker config tests + all existing tests pass
6. No tests require real torch, sentence-transformers, or Cohere SDK
</verification>

<success_criteria>
- test_embedders.py has 8+ tests covering SapBERT lazy loading, CLS pooling, dimensions, batch_size, import guard
- test_rerankers.py has 15+ tests covering normalize_scores, CrossEncoder (lazy load, ordering, edge cases), Cohere (degradation, API, env override), MockReranker
- test_vector_search_service.py has TestMatchOntologyReranking with 6 tests for service reranking integration
- test_config.py has TestRerankerConfig with 7 tests for config factory and env var
- All tests run without heavy ML dependencies (fully mocked)
- Total new tests: ~36+
</success_criteria>

<output>
After completion, create `.planning/phases/04-performance/04-02-SUMMARY.md`
</output>
