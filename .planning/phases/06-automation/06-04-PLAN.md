---
phase: 06-automation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/cloud-chromadb-handoff.md
autonomous: true
requirements: [CLOD-01, CLOD-02]

must_haves:
  truths:
    - "Handoff spec describes ChromaDB server mode deployment for vector.omics-os.com"
    - "Spec includes architecture diagram (text-based), API design, auth, and step-by-step deployment"
    - "Spec covers prewarmed indexes for all 3 ontologies (MONDO, Uberon, Cell Ontology)"
    - "A cloud engineer could deploy the service using only this document"
  artifacts:
    - path: "docs/cloud-chromadb-handoff.md"
      provides: "Cloud-hosted ChromaDB deployment specification"
      min_lines: 100
  key_links:
    - from: "docs/cloud-chromadb-handoff.md"
      to: "lobster/core/vector/backends/chromadb_backend.py"
      via: "Documents how ChromaDBBackend switches to HttpClient for cloud mode"
      pattern: "HttpClient|LOBSTER_VECTOR_CLOUD_URL"
---

<objective>
Write the cloud-hosted ChromaDB handoff specification for vector.omics-os.com deployment, covering architecture, authentication, API design, prewarmed indexes, and step-by-step deployment instructions.

Purpose: Provides a complete deployment blueprint for when Omics-OS Cloud users need server-side vector search instead of local ChromaDB. This is a planning document, not runtime code.
Output: `docs/cloud-chromadb-handoff.md`
</objective>

<execution_context>
@/Users/tyo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tyo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-automation/06-RESEARCH.md
@lobster/core/vector/backends/chromadb_backend.py
@lobster/core/vector/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write cloud-hosted ChromaDB handoff specification</name>
  <files>
    docs/cloud-chromadb-handoff.md
  </files>
  <action>
Create a comprehensive handoff spec in `docs/cloud-chromadb-handoff.md`. This is an internal planning document for the future cloud deployment. Structure:

**1. Overview**
- Purpose: Replace local ChromaDB PersistentClient with cloud-hosted ChromaDB server at vector.omics-os.com
- Trigger: When Omics-OS Cloud SaaS users need vector search without local model/data setup
- Scope: 3 ontology collections (MONDO, Uberon, Cell Ontology) with SapBERT 768d embeddings

**2. Architecture**
- Text-based architecture diagram (ASCII or Mermaid) showing:
  - Omics-OS Cloud (ECS) -> ALB -> ChromaDB Server (ECS) on vector.omics-os.com
  - ChromaDB runs in server mode (`chroma run --host 0.0.0.0 --port 8000`)
  - Persistent storage on EBS volume (not ephemeral container storage)
  - All 3 ontology collections prewarmed on startup
- Key design decisions:
  - ChromaDB server mode (not embedded) for multi-tenant access
  - Single ChromaDB instance (not per-tenant) since ontology data is shared/read-only
  - ECS Fargate task (ARM64/Graviton for cost) with 4 vCPU, 16GB RAM
  - EBS gp3 volume mounted at /data for ChromaDB persist directory

**3. Authentication & Authorization**
- ChromaDB server supports `CHROMA_SERVER_AUTHN_CREDENTIALS` for token auth
- Lobster Cloud backend sends auth token via `X-Chroma-Token` header
- Token injected from AWS Secrets Manager into ChromaDB ECS task definition
- Client-side: ChromaDB HttpClient initialized with `Settings(chroma_client_auth_provider="chromadb.auth.token.TokenAuthClientProvider", chroma_client_auth_credentials="<token>")`
- Cognito integration: Omics-OS Cloud API validates user session, then proxies to ChromaDB (users never call ChromaDB directly)

**4. API Design**
- Lobster SDK change: ChromaDBBackend detects `LOBSTER_VECTOR_CLOUD_URL` env var
  - If set: use `chromadb.HttpClient(host=url, port=8000, settings=auth_settings)` instead of PersistentClient
  - If not set: use PersistentClient (current behavior, unchanged)
- No new REST API needed -- ChromaDB server exposes its own HTTP API
- The existing VectorSearchService and all agent tools work unchanged (backend abstraction)

**5. Prewarmed Indexes**
- On ECS task startup, a custom entrypoint script:
  1. Checks if `/data/chroma/` has the 3 collections
  2. If missing: downloads tarballs from S3 (same URLs as ONTOLOGY_TARBALLS), extracts to /data/chroma/
  3. Starts ChromaDB server pointing at /data/chroma/
- First query after cold start should be <1s (data already in HNSW index)
- Health check: ALB target group hits ChromaDB `/api/v1/heartbeat` endpoint

**6. Deployment Steps**
Step-by-step CDK/AWS instructions:
1. Create ECS Fargate service with ChromaDB Docker image (`chromadb/chroma:latest`)
2. Configure EBS volume mount at /data
3. Set environment variables: CHROMA_SERVER_AUTHN_CREDENTIALS, IS_PERSISTENT=TRUE, PERSIST_DIRECTORY=/data/chroma
4. Create ALB target group routing vector.omics-os.com -> ChromaDB:8000
5. Create Route53 record for vector.omics-os.com
6. Store auth token in Secrets Manager
7. Add LOBSTER_VECTOR_CLOUD_URL to Omics-OS Cloud ECS task definition
8. Upload pre-built tarballs to S3 (same bucket as auto-download)

**7. Cost Estimate**
- ECS Fargate: ~$50-80/month (ARM64, 4 vCPU, 16GB, always-on)
- EBS gp3 10GB: ~$1/month
- ALB: ~$20/month
- Total: ~$70-100/month
- Note: Scale-to-zero not recommended (cold start would re-download/index)

**8. Migration Path**
- Phase 1 (this spec): Document architecture, no code changes
- Phase 2 (CLOD-V2-01): Deploy ChromaDB server, add HttpClient branch to ChromaDBBackend
- Phase 3 (CLOD-V2-02): Cognito-authenticated access for Omics-OS Cloud users

**9. Open Questions for Phase 2**
- Multi-region: Single us-east-1 or replicate to eu-west-1 for European users?
- Scaling: When do we need a second instance? Probably >1000 concurrent queries/sec
- Custom ontologies: Allow enterprise users to upload custom ontology collections?
  </action>
  <verify>
`wc -l docs/cloud-chromadb-handoff.md` shows at least 100 lines.
Document contains sections: Overview, Architecture, Authentication, API Design, Prewarmed Indexes, Deployment Steps, Cost Estimate, Migration Path.
  </verify>
  <done>
Cloud handoff spec at docs/cloud-chromadb-handoff.md covers: ChromaDB server mode architecture, Cognito auth via token, HttpClient switching via LOBSTER_VECTOR_CLOUD_URL, prewarmed indexes on ECS startup, step-by-step deployment instructions, cost estimate (~$70-100/mo), and 3-phase migration path. A cloud engineer can deploy vector.omics-os.com using this document.
  </done>
</task>

</tasks>

<verification>
1. `docs/cloud-chromadb-handoff.md` exists and is >100 lines
2. Document references correct S3 URLs matching ONTOLOGY_TARBALLS
3. Document references correct collection names (mondo_v2024_01, uberon_v2024_01, cell_ontology_v2024_01)
4. Architecture section includes deployment topology
5. Deployment steps are numbered and actionable
</verification>

<success_criteria>
- Cloud-hosted ChromaDB handoff spec written for vector.omics-os.com (CLOD-01)
- Spec includes architecture, auth (Cognito + token), prewarmed indexes, API design, and deployment steps (CLOD-02)
- Document is self-contained: a cloud engineer can deploy without additional context
</success_criteria>

<output>
After completion, create `.planning/phases/06-automation/06-04-SUMMARY.md`
</output>
