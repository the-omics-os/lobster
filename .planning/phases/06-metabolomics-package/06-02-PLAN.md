---
phase: 06-metabolomics-package
plan: 02
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified:
  - packages/lobster-metabolomics/lobster/agents/metabolomics/__init__.py
  - packages/lobster-metabolomics/lobster/agents/metabolomics/state.py
  - packages/lobster-metabolomics/lobster/agents/metabolomics/shared_tools.py
  - packages/lobster-metabolomics/lobster/agents/metabolomics/metabolomics_expert.py
autonomous: true
requirements:
  - MET-06
  - MET-07
  - MET-08
  - MET-09
  - MET-10
  - MET-11
  - MET-12
  - MET-13
  - MET-14
  - MET-15
  - MET-16

must_haves:
  truths:
    - "10 tools exist in shared_tools.py: assess_metabolomics_quality, filter_metabolomics_features, handle_missing_values, normalize_metabolomics, correct_batch_effects, run_metabolomics_statistics, run_multivariate_analysis, annotate_metabolites, analyze_lipid_classes, run_pathway_enrichment"
    - "metabolomics_expert agent factory creates a React agent with all 10 tools + delegation tools"
    - "AGENT_CONFIG is at module top before heavy imports in metabolomics_expert.py"
    - "Entry point in pyproject.toml resolves to AGENT_CONFIG for ComponentRegistry discovery"
    - "Each tool wraps its service, stores result modality via data_manager.store_modality, and logs IR via data_manager.log_tool_usage"
  artifacts:
    - path: "packages/lobster-metabolomics/lobster/agents/metabolomics/shared_tools.py"
      provides: "10 metabolomics tools via create_shared_tools factory"
      contains: "def create_shared_tools"
    - path: "packages/lobster-metabolomics/lobster/agents/metabolomics/metabolomics_expert.py"
      provides: "AGENT_CONFIG + metabolomics_expert factory function"
      contains: "AGENT_CONFIG"
    - path: "packages/lobster-metabolomics/lobster/agents/metabolomics/state.py"
      provides: "MetabolomicsExpertState for agent state management"
      contains: "class MetabolomicsExpertState"
    - path: "packages/lobster-metabolomics/lobster/agents/metabolomics/__init__.py"
      provides: "Module exports with graceful imports"
      contains: "METABOLOMICS_EXPERT_AVAILABLE"
  key_links:
    - from: "shared_tools.py assess_metabolomics_quality"
      to: "MetabolomicsQualityService.assess_quality"
      via: "Direct service call inside tool closure"
      pattern: "quality_service\\.assess_quality"
    - from: "shared_tools.py run_multivariate_analysis"
      to: "MetabolomicsAnalysisService.run_pca/run_pls_da/run_opls_da"
      via: "Method dispatch based on method parameter"
      pattern: "analysis_service\\.run_pca|run_pls_da|run_opls_da"
    - from: "shared_tools.py run_pathway_enrichment"
      to: "Core PathwayEnrichmentService"
      via: "Import from lobster.services.analysis (core, not package)"
      pattern: "PathwayEnrichmentService"
    - from: "metabolomics_expert.py factory"
      to: "create_shared_tools"
      via: "Creates service instances, passes to tool factory"
      pattern: "create_shared_tools.*data_manager.*quality_service"
    - from: "pyproject.toml entry point"
      to: "metabolomics_expert.py AGENT_CONFIG"
      via: "lobster.agents entry point group"
      pattern: "metabolomics_expert.*AGENT_CONFIG"
---

<objective>
Create all 10 metabolomics tools in shared_tools.py, the metabolomics_expert agent factory, state class, and module __init__.py. Register via entry points in pyproject.toml (already stubbed in Plan 01).

Purpose: Makes all metabolomics analysis capabilities accessible to the LLM agent. Each tool wraps a service method, handles modality storage, and logs provenance. The agent uses the standard React agent pattern with delegation support for future child agents.
Output: Working metabolomics_expert agent with 10 tools, discoverable via ComponentRegistry
</objective>

<execution_context>
@/Users/tyo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tyo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-metabolomics-package/06-01-SUMMARY.md
@.planning/phases/06-metabolomics-package/06-RESEARCH.md

# Reference: proteomics agent patterns (follow exactly)
@packages/lobster-proteomics/lobster/agents/proteomics/shared_tools.py
@packages/lobster-proteomics/lobster/agents/proteomics/proteomics_expert.py
@packages/lobster-proteomics/lobster/agents/proteomics/state.py
@packages/lobster-proteomics/lobster/agents/proteomics/__init__.py

# Services created in Plan 01 (need these for tool wiring)
@packages/lobster-metabolomics/lobster/agents/metabolomics/config.py
@packages/lobster-metabolomics/lobster/services/quality/metabolomics_quality_service.py
@packages/lobster-metabolomics/lobster/services/quality/metabolomics_preprocessing_service.py
@packages/lobster-metabolomics/lobster/services/analysis/metabolomics_analysis_service.py
@packages/lobster-metabolomics/lobster/services/annotation/metabolomics_annotation_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: State class + shared_tools.py with 10 tools</name>
  <files>
    packages/lobster-metabolomics/lobster/agents/metabolomics/state.py
    packages/lobster-metabolomics/lobster/agents/metabolomics/shared_tools.py
  </files>
  <action>
**state.py**: Create MetabolomicsExpertState following ProteomicsExpertState pattern exactly.
- Extend AgentState from `langgraph.prebuilt.chat_agent_executor`
- Fields: next (str), task_description (str), platform_type (str: "lc_ms"/"gc_ms"/"nmr")
- QC state: quality_metrics (Dict), preprocessing_applied (bool)
- Platform state: platform_defaults (Dict), missing_value_info (Dict), normalization_info (Dict)
- Analysis state: statistical_results (Dict), multivariate_results (Dict), annotation_results (Dict)
- Cross-cutting: file_paths (List[str]), intermediate_outputs (Dict)
- Export `__all__` with MetabolomicsExpertState

**shared_tools.py**: Create `create_shared_tools` factory function following proteomics shared_tools.py pattern.

Parameters: data_manager (DataManagerV2), quality_service (MetabolomicsQualityService), preprocessing_service (MetabolomicsPreprocessingService), analysis_service (MetabolomicsAnalysisService), annotation_service (MetabolomicsAnnotationService), force_platform_type (Optional[str])

Inside the factory, define a `_get_platform_for_modality(modality_name)` helper that uses detect_platform_type or forced type.

Define these 10 tools inside the factory closure (all decorated with @tool):

1. **assess_metabolomics_quality**(modality_name: str, qc_label: str = "QC", rsd_threshold: float = 30.0) -> str
   - Wraps quality_service.assess_quality()
   - Stores result as `{modality_name}_quality_assessed`
   - Logs tool usage with IR
   - Returns formatted report: samples, features, median RSD, high RSD count, missing %, TIC CV, QC stats if available

2. **filter_metabolomics_features**(modality_name: str, min_prevalence: float = 0.5, max_rsd: float = None, blank_ratio_threshold: float = None) -> str
   - Wraps preprocessing_service.filter_features()
   - Stores result as `{modality_name}_filtered`
   - Returns: features before/after, removed counts by criterion

3. **handle_missing_values**(modality_name: str, method: str = "knn", knn_neighbors: int = 5) -> str
   - Wraps preprocessing_service.impute_missing_values()
   - Validates method in ["knn", "min", "lod_half", "median", "mice"]
   - Stores result as `{modality_name}_imputed`
   - Returns: method used, values imputed, % imputed

4. **normalize_metabolomics**(modality_name: str, method: str = "pqn", log_transform: bool = True, reference_sample: str = None) -> str
   - Wraps preprocessing_service.normalize()
   - Uses platform defaults from _get_platform_for_modality if method not explicitly specified (but tool parameters take priority)
   - Stores result as `{modality_name}_normalized`
   - Returns: method, log_transformed, normalization factor range

5. **correct_batch_effects**(modality_name: str, batch_key: str, method: str = "combat", qc_label: str = "QC") -> str
   - Wraps preprocessing_service.correct_batch_effects()
   - Stores result as `{modality_name}_batch_corrected`
   - Returns: method, n_batches, batch sizes, correction summary

6. **run_metabolomics_statistics**(modality_name: str, group_column: str, method: str = "auto", fdr_method: str = "fdr_bh", fold_change_threshold: float = 1.5) -> str
   - Wraps analysis_service.run_univariate_statistics() AND analysis_service.calculate_fold_changes()
   - Runs both: statistics first, then fold changes
   - Stores result as `{modality_name}_statistics`
   - Returns: method used, n_significant (raw and FDR), fold change summary (up/down regulated)

7. **run_multivariate_analysis**(modality_name: str, method: str = "pca", n_components: int = 2, group_column: str = None, permutation_test: bool = True) -> str
   - Dispatches to analysis_service.run_pca(), run_pls_da(), or run_opls_da() based on method
   - Validates: group_column required for plsda/oplsda but not pca
   - Stores result as `{modality_name}_{method}`
   - Returns: method-specific results (PCA: variance explained; PLS-DA: R2, Q2, VIP>1 count, permutation p; OPLS-DA: R2, Q2, permutation p, overfitting warning if R2>>Q2)

8. **annotate_metabolites**(modality_name: str, ppm_tolerance: float = 10.0, adducts: str = None, ion_mode: str = "positive") -> str
   - Wraps annotation_service.annotate_by_mz()
   - Parse adducts string if provided (comma-separated), else use defaults for ion_mode
   - Stores result as `{modality_name}_annotated`
   - Returns: n_annotated, annotation rate, MSI level distribution

9. **analyze_lipid_classes**(modality_name: str) -> str
   - Wraps annotation_service.classify_lipids()
   - Stores result as `{modality_name}_lipid_classified`
   - Returns: n_classes found, class names with feature counts, MSI level

10. **run_pathway_enrichment**(modality_name: str, database: str = "KEGG_2021_Human", significance_threshold: float = 0.05) -> str
    - Import PathwayEnrichmentService from lobster.services.analysis (CORE, not package)
    - Use component_registry.get_service("pathway_enrichment") with fallback direct import (following D24 pattern from Phase 3)
    - Extract significant metabolite names from var (those with fdr < significance_threshold if statistics have been run, otherwise use annotation names)
    - Call pathway_enrichment_service.gene_set_enrichment_analysis() or overrepresentation_analysis() with metabolite list
    - Store results in uns['pathway_enrichment']
    - Stores result as `{modality_name}_pathway_enriched`
    - Returns: n_significant_pathways, top 5 pathway names with p-values

Return all 10 tools as a list from create_shared_tools.

Every tool MUST:
- Check modality exists with data_manager.get_modality(), return helpful error if not found
- Call data_manager.store_modality() with parent_name and step_summary
- Call data_manager.log_tool_usage() with tool_name, parameters dict, description, and ir=ir
- Return a human-readable string summary (this is what the LLM sees)
  </action>
  <verify>
    - `python -c "import ast; ast.parse(open('packages/lobster-metabolomics/lobster/agents/metabolomics/shared_tools.py').read()); print('shared_tools.py syntax OK')"`
    - `python -c "import ast; ast.parse(open('packages/lobster-metabolomics/lobster/agents/metabolomics/state.py').read()); print('state.py syntax OK')"`
    - `grep -c "@tool" packages/lobster-metabolomics/lobster/agents/metabolomics/shared_tools.py` returns 10
    - `grep "def create_shared_tools" packages/lobster-metabolomics/lobster/agents/metabolomics/shared_tools.py` confirms factory exists
    - `grep "class MetabolomicsExpertState" packages/lobster-metabolomics/lobster/agents/metabolomics/state.py` confirms state class
  </verify>
  <done>state.py has MetabolomicsExpertState. shared_tools.py has create_shared_tools factory returning 10 @tool functions, each wrapping its service, storing modalities, and logging IR.</done>
</task>

<task type="auto">
  <name>Task 2: Agent factory + __init__.py + entry point verification</name>
  <files>
    packages/lobster-metabolomics/lobster/agents/metabolomics/metabolomics_expert.py
    packages/lobster-metabolomics/lobster/agents/metabolomics/__init__.py
  </files>
  <action>
**metabolomics_expert.py**: Follow proteomics_expert.py pattern exactly.

1. AGENT_CONFIG at module top (BEFORE heavy imports):
```python
from lobster.config.agent_registry import AgentRegistryConfig

AGENT_CONFIG = AgentRegistryConfig(
    name="metabolomics_expert",
    display_name="Metabolomics Expert",
    description="Metabolomics analysis: LC-MS/GC-MS/NMR QC, preprocessing, multivariate statistics, metabolite annotation",
    factory_function="lobster.agents.metabolomics.metabolomics_expert.metabolomics_expert",
    handoff_tool_name="handoff_to_metabolomics_expert",
    handoff_tool_description="Assign metabolomics analysis tasks: LC-MS/GC-MS/NMR quality assessment, normalization (PQN/TIC), univariate/multivariate statistics (PCA/PLS-DA/OPLS-DA), metabolite annotation, lipid class analysis, pathway enrichment",
    child_agents=None,  # No children in v1 (structured for future extraction)
    supervisor_accessible=True,
    tier_requirement="free",
)
```

2. Heavy imports below AGENT_CONFIG:
   - Import Path, Optional from typing
   - Import numpy, tool from langchain_core.tools, create_react_agent from langgraph.prebuilt
   - Import create_shared_tools from shared_tools
   - Import MetabolomicsExpertState from state
   - Import create_llm from config, get_settings from config, DataManagerV2 from core
   - Import all 4 services
   - Import get_logger

3. Factory function `metabolomics_expert(data_manager, callback_handler=None, agent_name="metabolomics_expert", delegation_tools=None, force_platform_type=None, workspace_path=None, provider_override=None, model_override=None)`:
   - Lazy import of prompt: `from lobster.agents.metabolomics.prompts import create_metabolomics_expert_prompt` (D17 pattern)
   - Create LLM via create_llm() with provider/model overrides
   - Instantiate all 4 services (no constructor args needed - they are stateless)
   - Call create_shared_tools(data_manager, quality_service, preprocessing_service, analysis_service, annotation_service, force_platform_type)
   - Combine: tools = shared_tools + (delegation_tools or [])
   - Create system prompt via create_metabolomics_expert_prompt()
   - Create and return create_react_agent(model=llm, tools=tools, state_schema=MetabolomicsExpertState, prompt=system_prompt)

**__init__.py**: Follow proteomics __init__.py pattern exactly.
- Import MetabolomicsExpertState (always available)
- try/except ImportError block for premium components: config imports, prompt import, metabolomics_expert factory
- Set METABOLOMICS_EXPERT_AVAILABLE = True/False
- Define __all__ with all exports
  </action>
  <verify>
    - `python -c "import ast; ast.parse(open('packages/lobster-metabolomics/lobster/agents/metabolomics/metabolomics_expert.py').read()); print('expert.py syntax OK')"`
    - `python -c "import ast; ast.parse(open('packages/lobster-metabolomics/lobster/agents/metabolomics/__init__.py').read()); print('__init__.py syntax OK')"`
    - `grep "AGENT_CONFIG = AgentRegistryConfig" packages/lobster-metabolomics/lobster/agents/metabolomics/metabolomics_expert.py` confirms AGENT_CONFIG at top
    - `grep "child_agents=None" packages/lobster-metabolomics/lobster/agents/metabolomics/metabolomics_expert.py` confirms no children in v1
    - `grep "METABOLOMICS_EXPERT_AVAILABLE" packages/lobster-metabolomics/lobster/agents/metabolomics/__init__.py` confirms availability flag
    - After `pip install -e packages/lobster-metabolomics/`: `python -c "from lobster.agents.metabolomics.metabolomics_expert import AGENT_CONFIG; print(AGENT_CONFIG.name)"` prints "metabolomics_expert"
  </verify>
  <done>metabolomics_expert.py has AGENT_CONFIG at top + factory function with lazy prompt import. __init__.py has graceful imports with METABOLOMICS_EXPERT_AVAILABLE flag. Entry point in pyproject.toml (from Plan 01) resolves to AGENT_CONFIG for ComponentRegistry discovery.</done>
</task>

</tasks>

<verification>
- 10 @tool functions in shared_tools.py (grep -c "@tool" confirms)
- AGENT_CONFIG at top of metabolomics_expert.py (before heavy imports)
- MetabolomicsExpertState in state.py with metabolomics-specific fields
- __init__.py with graceful imports and METABOLOMICS_EXPERT_AVAILABLE flag
- After editable install, `python -c "from lobster.agents.metabolomics import METABOLOMICS_EXPERT_AVAILABLE; print(METABOLOMICS_EXPERT_AVAILABLE)"` prints True
</verification>

<success_criteria>
1. shared_tools.py has create_shared_tools factory returning exactly 10 tools
2. Each tool wraps service, stores modality, logs IR
3. metabolomics_expert.py has AGENT_CONFIG at top, factory with lazy prompt import
4. state.py has MetabolomicsExpertState
5. __init__.py has graceful imports
6. Entry point resolves: AGENT_CONFIG discoverable via ComponentRegistry
</success_criteria>

<output>
After completion, create `.planning/phases/06-metabolomics-package/06-02-SUMMARY.md`
</output>
