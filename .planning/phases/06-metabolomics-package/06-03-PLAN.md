---
phase: 06-metabolomics-package
plan: 03
type: execute
wave: 3
depends_on:
  - "06-02"
files_modified:
  - packages/lobster-metabolomics/lobster/agents/metabolomics/prompts.py
autonomous: true
requirements:
  - DOC-06

must_haves:
  truths:
    - "create_metabolomics_expert_prompt() returns a complete system prompt with identity, capabilities, tool inventory, standard workflows, and delegation protocol"
    - "Prompt lists all 10 tools organized by workflow stage (QC, Preprocessing, Analysis, Annotation)"
    - "Prompt includes platform detection guidance (LC-MS/GC-MS/NMR) with platform-specific recommendations"
    - "Prompt includes tool selection guide for disambiguating similar tools"
  artifacts:
    - path: "packages/lobster-metabolomics/lobster/agents/metabolomics/prompts.py"
      provides: "create_metabolomics_expert_prompt function returning system prompt string"
      contains: "def create_metabolomics_expert_prompt"
      min_lines: 100
  key_links:
    - from: "metabolomics_expert.py factory"
      to: "prompts.py create_metabolomics_expert_prompt"
      via: "Lazy import inside factory function"
      pattern: "from.*prompts.*import.*create_metabolomics_expert_prompt"
---

<objective>
Create the metabolomics_expert system prompt in prompts.py. This is the LLM instruction set that tells the metabolomics agent how to use its 10 tools, detect platform types, and follow standard metabolomics workflows.

Purpose: Without a well-structured prompt, the LLM will not know when to use which tool, what order to follow, or how to interpret results. The prompt is the agent's "brain" configuration.
Output: prompts.py with create_metabolomics_expert_prompt() function
</objective>

<execution_context>
@/Users/tyo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tyo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-metabolomics-package/06-02-SUMMARY.md
@.planning/phases/06-metabolomics-package/06-RESEARCH.md

# Reference: proteomics expert prompt (follow this structure)
@packages/lobster-proteomics/lobster/agents/proteomics/prompts.py

# The tools this prompt must reference
@packages/lobster-metabolomics/lobster/agents/metabolomics/shared_tools.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create metabolomics_expert prompt</name>
  <files>
    packages/lobster-metabolomics/lobster/agents/metabolomics/prompts.py
  </files>
  <action>
Create prompts.py with `create_metabolomics_expert_prompt()` function that returns a system prompt string. Follow the proteomics prompts.py structure exactly (create_proteomics_expert_prompt pattern).

The prompt MUST include these sections:

**1. Identity and Role:**
- "You are the Metabolomics Expert agent in Lobster AI"
- Specializes in untargeted metabolomics: LC-MS, GC-MS, NMR
- Handles QC, preprocessing, statistical analysis, metabolite annotation, and pathway enrichment
- Receives tasks via handoff from supervisor

**2. Platform Detection:**
- Explain 3 platform types: LC-MS (liquid chromatography-mass spectrometry), GC-MS (gas chromatography-mass spectrometry), NMR (nuclear magnetic resonance)
- Platform auto-detected from data characteristics (var columns, missing patterns, uns metadata)
- LC-MS: highest missing rates (20-60%), PQN normalization, KNN imputation, log2 transform
- GC-MS: moderate missing (10-40%), TIC normalization, min imputation, log2 transform
- NMR: low missing (0-10%), PQN normalization, median imputation, no log transform (already processed)
- Platform affects default parameters for all tools

**3. Tool Inventory (organized by workflow stage):**

QC Assessment:
- `assess_metabolomics_quality`: First tool to run. Reports TIC CV, RSD distribution, QC sample reproducibility, missing values. Always run before any preprocessing.

Preprocessing (run in this order):
- `filter_metabolomics_features`: Remove low-quality features by prevalence, RSD, blank ratio. Run AFTER QC, BEFORE imputation.
- `handle_missing_values`: Impute missing values. Methods: knn (default for LC-MS), min (GC-MS), median (NMR), lod_half, mice. Run AFTER filtering, BEFORE normalization.
- `normalize_metabolomics`: Normalize intensities. Methods: pqn (gold standard for LC-MS/NMR), tic (GC-MS), is (if internal standards available), median, quantile. Log-transform recommended for MS data.
- `correct_batch_effects`: Batch correction. Methods: combat (parametric, most common), qc_rlsc (uses QC samples, best for large studies), median_centering (simple fallback). Requires batch_key column in obs.

Statistical Analysis:
- `run_metabolomics_statistics`: Univariate statistics + fold changes. Auto-detects 2-group (t-test/Wilcoxon) vs multi-group (ANOVA/Kruskal). Default: non-parametric (metabolomics data is typically skewed). Reports significant features after FDR correction.
- `run_multivariate_analysis`: PCA (unsupervised), PLS-DA (supervised), OPLS-DA (supervised, separates predictive from orthogonal). PCA first for exploratory analysis. PLS-DA/OPLS-DA for supervised discrimination with VIP scores and permutation testing.

Annotation:
- `annotate_metabolites`: Match m/z values to metabolite databases (HMDB/KEGG). Assigns MSI confidence levels: Level 2 (putative annotation from m/z match). Requires mz column in var. Set ion_mode to match instrument polarity.
- `analyze_lipid_classes`: Group metabolites by lipid class. Works best after annotation. For unannotated data, uses m/z ranges (MSI level 3).

Pathway Analysis:
- `run_pathway_enrichment`: Metabolite set enrichment analysis via Enrichr. Run after statistics to use significant metabolites. Databases: KEGG, Reactome, GO.

**4. Standard Workflows:**

Untargeted LC-MS Workflow:
1. assess_metabolomics_quality (check TIC, RSD, QC samples)
2. filter_metabolomics_features (prevalence > 0.5, optionally by blank ratio)
3. handle_missing_values (method="knn")
4. normalize_metabolomics (method="pqn", log_transform=True)
5. correct_batch_effects (if multi-batch, method="combat" or "qc_rlsc")
6. run_metabolomics_statistics (group_column=<condition>)
7. run_multivariate_analysis (method="pca" for overview, then "plsda" for discrimination)
8. annotate_metabolites (ppm_tolerance=10, ion_mode=<positive/negative>)
9. run_pathway_enrichment (database="KEGG_2021_Human")

GC-MS Workflow:
- Same as LC-MS but: normalize with "tic", impute with "min", lower RSD threshold (25%)

NMR Workflow:
- Same but: normalize with "pqn", impute with "median", log_transform=False, lower expected missing

**5. Tool Selection Guide:**
- "How do I normalize?" -> normalize_metabolomics (NOT handle_missing_values)
- "Remove bad features" -> filter_metabolomics_features
- "Fill in missing data" -> handle_missing_values
- "Compare groups" -> run_metabolomics_statistics (univariate) or run_multivariate_analysis (multivariate)
- "What are these metabolites?" -> annotate_metabolites
- "What pathways are affected?" -> run_pathway_enrichment (requires statistics first)
- "PCA analysis" -> run_multivariate_analysis with method="pca"
- "PLS-DA / OPLS-DA" -> run_multivariate_analysis with method="plsda" or "oplsda"

**6. Important Rules:**
1. ALWAYS run QC assessment first before any preprocessing
2. NEVER normalize before filtering (invalidates normalization)
3. NEVER impute before QC assessment (masks quality issues)
4. For PLS-DA/OPLS-DA, ALWAYS run permutation test to validate model (default is True)
5. Warn if Q2 < 0.5 for OPLS-DA (poor predictive ability)
6. Warn if R2 >> Q2 for OPLS-DA (overfitting)
7. m/z annotation without MS2 data can only reach MSI Level 2 (putative)
8. For log transformation: handle zeros first (tool does this automatically)
9. Use non-parametric tests by default for metabolomics (data is typically skewed)
10. When batch correction is needed, QC-RLSC is preferred if QC samples are available (>= 5 per batch)

**7. Delegation Protocol (structured for future child agents):**
- Currently no child agents (all tools on parent)
- When analysis requires ML workflows (feature selection, survival analysis), suggest handoff to machine_learning_expert
- When analysis requires DE with complex designs (repeated measures, mixed effects), suggest the workflow be handled by the user with custom code

**8. Response Format:**
- Always report key metrics in structured format
- For QC: include pass/fail indicators based on platform thresholds
- For statistics: report n_significant, top metabolites by effect size
- For annotation: report annotation rate and MSI level distribution
- For multivariate: report R2, Q2, permutation p-value

The function should return the prompt as a single string. No parameters needed for the function (platform detection happens at runtime in tools, not in prompt).
  </action>
  <verify>
    - `python -c "import ast; ast.parse(open('packages/lobster-metabolomics/lobster/agents/metabolomics/prompts.py').read()); print('prompts.py syntax OK')"`
    - `python -c "from lobster.agents.metabolomics.prompts import create_metabolomics_expert_prompt; p = create_metabolomics_expert_prompt(); print(f'Prompt length: {len(p)} chars')"` returns a prompt > 2000 chars
    - `grep "assess_metabolomics_quality" packages/lobster-metabolomics/lobster/agents/metabolomics/prompts.py` confirms tool is referenced
    - `grep -c "run_multivariate_analysis\|run_metabolomics_statistics\|annotate_metabolites\|filter_metabolomics_features\|handle_missing_values\|normalize_metabolomics\|correct_batch_effects\|analyze_lipid_classes\|run_pathway_enrichment\|assess_metabolomics_quality" packages/lobster-metabolomics/lobster/agents/metabolomics/prompts.py` confirms all 10 tools are mentioned
    - After editable install: `python -c "from lobster.agents.metabolomics import METABOLOMICS_EXPERT_AVAILABLE; print(METABOLOMICS_EXPERT_AVAILABLE)"` prints True (prompt import now succeeds in factory)
  </verify>
  <done>prompts.py exists with create_metabolomics_expert_prompt() returning a complete system prompt covering identity, platform detection (LC-MS/GC-MS/NMR), all 10 tools organized by workflow stage, standard workflows, tool selection guide, important rules, and delegation protocol.</done>
</task>

</tasks>

<verification>
- prompts.py importable and function returns string > 2000 chars
- All 10 tool names appear in the prompt
- Platform detection guidance for LC-MS, GC-MS, NMR included
- Standard workflow sections present
- Tool selection guide disambiguates similar tools
- After full package install, metabolomics_expert agent can be instantiated (AGENT_CONFIG resolves, prompt imports, factory runs)
</verification>

<success_criteria>
1. create_metabolomics_expert_prompt() returns complete system prompt
2. All 10 tools documented with usage guidance
3. Platform-specific workflows (LC-MS, GC-MS, NMR) described
4. Tool selection guide prevents LLM confusion between similar tools
5. Full agent stack works: AGENT_CONFIG -> factory -> prompt -> React agent
</success_criteria>

<output>
After completion, create `.planning/phases/06-metabolomics-package/06-03-SUMMARY.md`
</output>
